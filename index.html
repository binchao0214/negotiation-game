<!DOCTYPE html>
<html lang="zh-Hant">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>談判思維刻意練習場</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@400;500;700&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Noto Sans TC', sans-serif; }
        .screen { display: none; }
        .screen.active { display: block; }
        input[type=range] { -webkit-appearance: none; appearance: none; width: 100%; height: 8px; background: #d3d3d3; outline: none; opacity: 0.7; transition: opacity .2s; border-radius: 5px; }
        input[type=range]:hover { opacity: 1; }
        input[type=range]::-webkit-slider-thumb { -webkit-appearance: none; appearance: none; width: 20px; height: 20px; background: #0ea5e9; cursor: pointer; border-radius: 50%; border: 2px solid white; box-shadow: 0 0 5px rgba(0,0,0,0.2); }
        input[type=range]::-moz-range-thumb { width: 20px; height: 20px; background: #0ea5e9; cursor: pointer; border-radius: 50%; border: 2px solid white; box-shadow: 0 0 5px rgba(0,0,0,0.2); }
        .hidden { display: none; }
        .modal-overlay { transition: opacity 0.3s ease; }
        .modal-content { transition: transform 0.3s ease, opacity 0.3s ease; }
        @keyframes fade-in-up { from { transform: translateY(20px) scale(0.95); opacity: 0; } to { transform: translateY(0) scale(1); opacity: 1; } }
        .animate-fade-in-up { animation: fade-in-up 0.3s ease-out forwards; }
        .loading-spinner { border: 4px solid rgba(255, 255, 255, 0.3); border-left-color: #ffffff; border-radius: 50%; width: 24px; height: 24px; animation: spin 1s linear infinite; }
        @keyframes spin { to { transform: rotate(360deg); } }
    </style>
</head>
<body class="bg-slate-100 text-slate-800">

    <div id="app" class="container mx-auto p-4 md:p-8 max-w-5xl">
        <div id="modal" class="fixed inset-0 bg-black bg-opacity-60 items-center justify-center z-50 hidden modal-overlay">
            <div class="bg-white p-6 rounded-lg shadow-xl w-11/12 max-w-md transform scale-95 opacity-0 modal-content">
                <h2 id="modal-title" class="text-2xl font-bold text-slate-800 mb-4"></h2>
                <div id="modal-body" class="text-slate-600 space-y-2"></div>
                <div class="text-right mt-6">
                    <button id="modal-close-btn" class="bg-sky-600 text-white font-bold py-2 px-6 rounded-lg hover:bg-sky-700 transition">關閉</button>
                </div>
            </div>
        </div>
        <div id="success-modal" class="fixed inset-0 bg-black bg-opacity-60 items-center justify-center z-50 hidden">
            <div class="bg-white p-8 rounded-lg shadow-xl text-center transform transition-all scale-95 opacity-0 animate-fade-in-up">
                <h2 class="text-3xl font-bold text-green-600">成交！</h2>
                <p class="text-lg mt-2 text-slate-700">這工程有勞你了！</p>
            </div>
        </div>
        <header class="text-center mb-8">
            <h1 class="text-3xl md:text-4xl font-bold text-slate-900">談判思維刻意練習場</h1>
            <p class="text-slate-600 mt-2">在模擬場景中，磨練您的談判技巧</p>
        </header>

        <div id="start-screen" class="screen active space-y-6">
            <div class="bg-white p-6 rounded-lg shadow-md">
                <h2 class="text-2xl font-bold mb-4 border-b pb-2">場景設定：商業綜合體總承包</h2>
                <p>您將扮演 <span class="font-bold text-sky-600">承包商</span>，與 AI 扮演的 <span class="font-bold text-red-600">業主</span> 就一個新的商業綜合體建設項目進行總承包談判。您的核心利益參數和談判底線（BATNA）如下：</p>
            </div>
            <div class="grid md:grid-cols-2 gap-6">
                <div class="bg-white p-6 rounded-lg shadow-md">
                    <h3 class="text-xl font-bold mb-4">您的核心利益參數</h3>
                    <ul class="space-y-3">
                        <li><strong>總造價 (元)</strong>: 期望 <span class="text-green-600">10,500,000</span> | 底線 <span class="text-red-600">9,000,000</span></li>
                        <li><strong>工期 (天)</strong>: 期望 <span class="text-green-600">330</span> | 底線 <span class="text-red-600">240</span></li>
                        <li><strong>保修期 (年)</strong>: 期望 <span class="text-green-600">1</span> | 底線 <span class="text-red-600">4</span></li>
                        <li><strong>預付款 (%)</strong>: 期望 <span class="text-green-600">25</span> | 底線 <span class="text-red-600">15</span></li>
                        <li><strong>附加義務等級</strong>: 期望 <span class="text-green-600">1 (輕度)</span> | 底線 <span class="text-red-600">4 (重度)</span></li>
                    </ul>
                </div>
                <div class="bg-white p-6 rounded-lg shadow-md">
                    <h3 class="text-xl font-bold mb-4">您的 BATNA (最佳替代方案)</h3>
                    <div class="bg-amber-100 border-l-4 border-amber-500 text-amber-800 p-4 rounded-r-lg">
                        <p>接受另一個住宅項目合約：</p>
                        <ul class="list-disc list-inside mt-2">
                            <li>報價: 9,500,000 元</li>
                            <li>工期: 300 天</li>
                            <li>保修期: 2 年</li>
                            <li>預付款: 15%</li>
                            <li>附加義務: 等級 2 (一般義務)</li>
                        </ul>
                    </div>
                </div>
            </div>
             <div class="bg-white p-6 rounded-lg shadow-md">
                <h3 class="text-xl font-bold mb-4">附加義務等級定義</h3>
                <div id="obligation-definitions-start" class="text-sm space-y-2 text-slate-600"></div>
            </div>
            <div class="bg-white p-6 rounded-lg shadow-md">
                 <h2 class="text-2xl font-bold mb-4 text-center">開局信息</h2>
                 <div class="bg-sky-100 border-t-4 border-sky-500 rounded-b text-sky-900 px-4 py-3 shadow-md" role="alert">
                    <div class="flex">
                        <div class="py-1"><svg class="fill-current h-6 w-6 text-sky-500 mr-4" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20"><path d="M2.93 17.07A10 10 0 1 1 17.07 2.93 10 10 0 0 1 2.93 17.07zM9 11v4h2v-4H9zm0-4h2v2H9V7z"/></svg></div>
                        <div>
                            <p class="font-bold">本次 AI 業主的談判風格為：<span id="ai-style-info" class="text-red-600"></span></p>
                            <p class="text-sm" id="ai-leaked-info"></p>
                        </div>
                    </div>
                </div>
            </div>
            <div class="text-center">
                <button id="start-game-btn" class="bg-sky-600 text-white font-bold py-3 px-8 rounded-lg shadow-lg hover:bg-sky-700 transition-transform transform hover:scale-105 disabled:bg-slate-400" disabled>
                    正在載入...
                </button>
            </div>
        </div>
        
        <div id="game-screen" class="screen">
             <div class="grid lg:grid-cols-3 gap-6">
                <div class="lg:col-span-2 bg-white p-6 rounded-lg shadow-md">
                    <h2 class="text-2xl font-bold mb-6 border-b pb-3">您的方案</h2>
                    <div id="negotiation-form" class="space-y-6">
                        <div>
                            <label for="cost" class="flex justify-between font-medium"><span>總造價 (元)</span><span id="cost-value" class="font-bold text-sky-600"></span></label>
                            <input type="range" id="cost" min="8500000" max="11000000" step="50000" value="10500000">
                        </div>
                        <div>
                            <label for="duration" class="flex justify-between font-medium"><span>工期 (天)</span><span id="duration-value" class="font-bold text-sky-600"></span></label>
                            <input type="range" id="duration" min="200" max="350" step="5" value="330">
                        </div>
                        <div>
                            <label for="warranty" class="flex justify-between font-medium"><span>保修期 (年)</span><span id="warranty-value" class="font-bold text-sky-600"></span></label>
                            <input type="range" id="warranty" min="1" max="5" step="1" value="1">
                        </div>
                        <div>
                            <label for="prepayment" class="flex justify-between font-medium"><span>預付款 (%)</span><span id="prepayment-value" class="font-bold text-sky-600"></span></label>
                            <input type="range" id="prepayment" min="10" max="30" step="1" value="25">
                        </div>
                        <div>
                            <label for="obligation" class="flex justify-between font-medium"><span>附加義務等級</span><span id="obligation-value" class="font-bold text-sky-600"></span></label>
                            <input type="range" id="obligation" min="1" max="5" step="1" value="1">
                            <div id="obligation-description-game" class="mt-2 text-sm bg-slate-100 p-3 rounded-md text-slate-700"></div>
                        </div>
                    </div>
                     <div class="mt-8 flex flex-wrap gap-4 items-center">
                        <button id="submit-offer-btn" class="bg-sky-600 text-white font-bold py-2 px-6 rounded-lg hover:bg-sky-700 transition disabled:bg-slate-400 flex items-center justify-center gap-2">提交方案</button>
                        <button id="end-negotiation-btn" class="bg-red-500 text-white font-bold py-2 px-6 rounded-lg hover:bg-red-600 transition">放棄談判</button>
                    </div>
                </div>
                <div class="space-y-6">
                    <div class="bg-white p-4 rounded-lg shadow-md">
                        <h3 class="text-lg font-bold mb-3">業主 (AI) 回應</h3>
                        <div id="ai-response" class="min-h-[100px] bg-slate-100 p-3 rounded-md text-slate-700 italic">等待您提交第一個方案...</div>
                    </div>
                    <div class="bg-white p-4 rounded-lg shadow-md">
                         <h3 class="text-lg font-bold mb-3">您的底線</h3>
                         <button id="view-batna-btn" class="w-full bg-amber-500 text-white font-bold py-2 px-4 rounded-lg hover:bg-amber-600 transition">查看我的 BATNA</button>
                    </div>
                </div>
            </div>
        </div>

        <div id="report-screen" class="screen space-y-6">
             <div id="result-summary" class="p-6 rounded-lg shadow-md text-center">
                <h2 id="result-title" class="text-4xl font-bold mb-2"></h2>
                <p id="result-text" class="text-lg"></p>
                <p class="text-md text-slate-600 mt-2">本次業主的談判風格為: <span id="report-ai-style" class="font-bold"></span></p>
            </div>
            <div class="bg-white p-6 rounded-lg shadow-md">
                <h3 class="text-xl font-bold mb-4">最終方案對比</h3>
                <div class="overflow-x-auto">
                    <table class="w-full text-sm text-left">
                        <thead class="bg-slate-100">
                            <tr>
                                <th class="p-3">參數</th>
                                <th class="p-3 text-sky-600">您的最終方案</th>
                                <th class="p-3 text-green-600">您的期望</th>
                                <th class="p-3 text-red-600">您的底線</th>
                                <th class="p-3 text-red-600">業主底線</th>
                                <th class="p-3 text-green-600">業主期望</th>
                            </tr>
                        </thead>
                        <tbody id="report-table-body"></tbody>
                    </table>
                </div>
            </div>
            <div class="grid md:grid-cols-3 gap-6">
                <div class="md:col-span-2 bg-white p-6 rounded-lg shadow-md">
                    <h3 class="text-xl font-bold mb-4">"成交區間"可視化分析 (ZOPA)</h3>
                    <div id="deal-zone-analysis" class="space-y-2"></div>
                </div>
                <div class="space-y-6">
                    <div class="bg-white p-6 rounded-lg shadow-md">
                        <h3 class="text-xl font-bold mb-4">行為統計</h3>
                        <ul id="behavior-stats" class="space-y-2"></ul>
                    </div>
                    <div class="bg-white p-6 rounded-lg shadow-md">
                        <h3 class="text-xl font-bold mb-4">雙方滿意度評估</h3>
                        <div id="satisfaction-scores" class="space-y-2"></div>
                    </div>
                </div>
            </div>
            <div class="bg-white p-6 rounded-lg shadow-md">
                <h3 class="text-xl font-bold mb-4">智能提示</h3>
                <div id="smart-tips" class="bg-sky-100 border-l-4 border-sky-500 text-sky-800 p-4 rounded-r-lg space-y-2"></div>
            </div>
            <div class="text-center mt-6">
                 <button id="play-again-btn" class="bg-sky-600 text-white font-bold py-3 px-8 rounded-lg shadow-lg hover:bg-sky-700 transition-transform transform hover:scale-105">再玩一次</button>
            </div>
        </div>
    </div>

<script>
document.addEventListener('DOMContentLoaded', () => {
    // --- DOM Elements ---
    const screens = { start: document.getElementById('start-screen'), game: document.getElementById('game-screen'), report: document.getElementById('report-screen') };
    const buttons = { startGame: document.getElementById('start-game-btn'), submitOffer: document.getElementById('submit-offer-btn'), endNegotiation: document.getElementById('end-negotiation-btn'), viewBatna: document.getElementById('view-batna-btn'), playAgain: document.getElementById('play-again-btn'), modalClose: document.getElementById('modal-close-btn') };
    const inputs = { cost: document.getElementById('cost'), duration: document.getElementById('duration'), warranty: document.getElementById('warranty'), prepayment: document.getElementById('prepayment'), obligation: document.getElementById('obligation') };
    const displays = {
        costValue: document.getElementById('cost-value'), durationValue: document.getElementById('duration-value'), warrantyValue: document.getElementById('warranty-value'), prepaymentValue: document.getElementById('prepayment-value'), obligationValue: document.getElementById('obligation-value'),
        obligationDescGame: document.getElementById('obligation-description-game'), obligationDefsStart: document.getElementById('obligation-definitions-start'), aiResponse: document.getElementById('ai-response'), aiStyleInfo: document.getElementById('ai-style-info'), aiLeakedInfo: document.getElementById('ai-leaked-info'),
        resultTitle: document.getElementById('result-title'), resultText: document.getElementById('result-text'), reportAiStyle: document.getElementById('report-ai-style'), reportTableBody: document.getElementById('report-table-body'),
        dealZoneAnalysis: document.getElementById('deal-zone-analysis'), behaviorStats: document.getElementById('behavior-stats'), satisfactionScores: document.getElementById('satisfaction-scores'), smartTips: document.getElementById('smart-tips'),
        successModal: document.getElementById('success-modal'), modal: document.getElementById('modal'), modalTitle: document.getElementById('modal-title'), modalBody: document.getElementById('modal-body'),
    };
    
    // --- Frontend State ---
    let gameStateToken = null; // This token securely stores backend state
    const OBLIGATION_LEVELS = { 1: { name: '輕度義務' }, 2: { name: '一般義務' }, 3: { name: '中度義務' }, 4: { name: '重度義務' }, 5: { name: '全面義務' } };
    const OBLIGATION_DEFS = { 1: '配合標準審計流程，提供常規進度報告。', 2: '除標準報告外，需提供額外的專項報告（如環保、安全）。', 3: '需承擔與所有由業主直接指定的分包商的協調管理責任。', 4: '需承擔因非承包商原因導致的部分設計變更（累計不超過合約價5%）所引發的現場管理成本。', 5: '需承擔項目範圍內全部未知地質條件、以及因極端天氣導致的工期延誤風險。' };
    
    // --- API Communication ---
    async function apiCall(action, payload = {}) {
        try {
            const response = await fetch('/api/negotiate', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ action, ...payload }),
            });
            if (!response.ok) throw new Error(`API Error: ${response.statusText}`);
            return await response.json();
        } catch (error) {
            console.error('API call failed:', error);
            alert('與伺服器通信失敗，請刷新頁面重試。');
            return null;
        }
    }

    // --- UI Functions ---
    function switchScreen(screenName) { Object.values(screens).forEach(s => s.classList.remove('active')); screens[screenName].classList.add('active'); }
    function showModal(title, bodyHTML) { displays.modal.classList.remove('hidden'); displays.modal.classList.add('flex'); displays.modalTitle.textContent = title; displays.modalBody.innerHTML = bodyHTML; setTimeout(() => { displays.modal.querySelector('.modal-content').classList.add('scale-100', 'opacity-100'); displays.modal.classList.add('opacity-100'); }, 10); }
    function hideModal() { displays.modal.querySelector('.modal-content').classList.remove('scale-100', 'opacity-100'); displays.modal.classList.remove('opacity-100'); setTimeout(() => displays.modal.classList.add('hidden'), 300); }
    function updateSliderValue(key, value) {
        let displayValue = value;
        if (key === 'cost') {
            displayValue = parseInt(value).toLocaleString();
        } else if (key === 'obligation') {
            if (OBLIGATION_LEVELS && OBLIGATION_LEVELS[value]) {
                displayValue = `${value} (${OBLIGATION_LEVELS[value].name})`;
                displays.obligationDescGame.textContent = `等級 ${value}: ${OBLIGATION_DEFS[value]}`;
            }
        }
        if (displays[`${key}Value`]) {
            displays[`${key}Value`].textContent = displayValue;
        }
    }
    function toggleButtonLoading(button, isLoading) {
        if (isLoading) {
            button.disabled = true;
            button.dataset.originalText = button.innerHTML;
            button.innerHTML = `<div class="loading-spinner"></div><span>處理中...</span>`;
        } else {
            button.disabled = false;
            button.innerHTML = button.dataset.originalText;
        }
    }
    
    // --- Game Logic Flow ---
    async function init() {
        switchScreen('start');
        buttons.startGame.disabled = true;
        buttons.startGame.textContent = '正在載入...';
        
        const data = await apiCall('init');
        
        if (data) {
            gameStateToken = data.token;
            displays.aiStyleInfo.textContent = data.aiStyleName;
            displays.aiLeakedInfo.innerHTML = data.leakedInfoHTML;
            buttons.startGame.disabled = false;
            buttons.startGame.textContent = '開始談判';
        } else {
            // If API call fails, stop the loading state
            buttons.startGame.textContent = '載入失敗，請刷新';
        }

        displays.obligationDefsStart.innerHTML = Object.entries(OBLIGATION_DEFS).map(([i, desc]) => `<p><span class="font-bold">等級 ${i} (${OBLIGATION_LEVELS[i].name}):</span> ${desc}</p>`).join('');
        
        for (const key in inputs) {
            updateSliderValue(key, inputs[key].value);
        }
        displays.aiResponse.innerHTML = '等待您提交第一個方案...';
    }

    async function handleSubmitOffer() {
        toggleButtonLoading(buttons.submitOffer, true);
        const offer = Object.fromEntries(Object.entries(inputs).map(([key, input]) => [key, parseInt(input.value)]));
        
        const data = await apiCall('submit', { token: gameStateToken, offer });
        
        if (data) {
            gameStateToken = data.token;
            if (data.isDeal) {
                showSuccessAndReport(data.reportData);
            } else {
                displays.aiResponse.innerHTML = data.aiResponseHTML;
            }
        }
        toggleButtonLoading(buttons.submitOffer, false);
    }

    function showSuccessAndReport(reportData) {
        displays.successModal.classList.remove('hidden');
        displays.successModal.classList.add('flex');
        setTimeout(() => { 
            if(displays.successModal.querySelector('div')) {
               displays.successModal.querySelector('div').classList.add('scale-100', 'opacity-100');
            }
        }, 10);
        
        setTimeout(() => {
             if(displays.successModal.querySelector('div')) {
                displays.successModal.querySelector('div').classList.remove('scale-100', 'opacity-100');
             }
            setTimeout(() => {
                displays.successModal.classList.add('hidden');
                displays.successModal.classList.remove('flex');
                renderReport(reportData);
            }, 300);
        }, 2500);
    }
    
    async function handleEndNegotiation() {
        const reportData = await apiCall('end', { token: gameStateToken });
        if(reportData) {
            renderReport(reportData);
        }
    }

    function renderReport(data) {
        displays.resultTitle.textContent = data.isSuccess ? '談判成功！' : '談判破裂';
        displays.resultTitle.className = data.isSuccess ? 'text-4xl font-bold mb-2 text-green-600' : 'text-4xl font-bold mb-2 text-red-600';
        displays.resultText.textContent = data.resultText;
        displays.reportAiStyle.textContent = data.aiStyleName;
        displays.reportTableBody.innerHTML = data.reportTableHTML;
        displays.dealZoneAnalysis.innerHTML = data.dealZoneAnalysisHTML;
        displays.behaviorStats.innerHTML = data.behaviorStatsHTML;
        displays.satisfactionScores.innerHTML = data.satisfactionScoresHTML;
        displays.smartTips.innerHTML = data.smartTipsHTML;
        switchScreen('report');
    }

    // --- Event Listeners ---
    buttons.startGame.addEventListener('click', () => {
        displays.aiResponse.innerHTML = '等待您提交第一個方案...';
        switchScreen('game');
    });
    buttons.submitOffer.addEventListener('click', handleSubmitOffer);
    buttons.endNegotiation.addEventListener('click', handleEndNegotiation);
    buttons.playAgain.addEventListener('click', init);
    buttons.viewBatna.addEventListener('click', () => {
        apiCall('viewBatna', { token: gameStateToken }).then(data => { if(data) gameStateToken = data.token; });
        const batnaHTML = `
            <p class="font-bold">您的最佳替代方案是一個住宅項目合約，其價值可量化為：</p>
            <ul class="list-disc list-inside mt-2 space-y-1 text-slate-700">
                <li><strong>報價:</strong> 9,500,000 元</li>
                <li><strong>工期:</strong> 300 天</li>
                <li><strong>保修期:</strong> 2 年</li>
                <li><strong>預付款:</strong> 15%</li>
                <li><strong>附加義務:</strong> 等級 2 (一般義務)</li>
            </ul>
            <p class="mt-4 text-sm bg-amber-100 p-2 rounded">當前談判的條件若劣於此方案，您應當選擇放棄。</p>
        `;
        showModal('您的 BATNA (最佳替代方案)', batnaHTML);
    });
    buttons.modalClose.addEventListener('click', hideModal);
    Object.entries(inputs).forEach(([key, input]) => {
        if(input) {
            input.addEventListener('input', (e) => updateSliderValue(key, e.target.value));
        }
    });

    // --- Initial Load ---
    init();
});
</script>

</body>
</html>
