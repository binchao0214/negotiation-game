<!DOCTYPE html>
<html lang="zh-Hant">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>談判思維刻意練習場 / Negotiation Sandbox</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@400;500;700&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Noto Sans TC', sans-serif; }
        .screen { display: none; }
        .screen.active { display: block; }
        input[type=range] { -webkit-appearance: none; appearance: none; width: 100%; height: 8px; background: #d3d3d3; outline: none; opacity: 0.7; transition: opacity .2s; border-radius: 5px; }
        input[type=range]:hover { opacity: 1; }
        input[type=range]::-webkit-slider-thumb { -webkit-appearance: none; appearance: none; width: 20px; height: 20px; background: #0ea5e9; cursor: pointer; border-radius: 50%; border: 2px solid white; box-shadow: 0 0 5px rgba(0,0,0,0.2); }
        input[type=range]::-moz-range-thumb { width: 20px; height: 20px; background: #0ea5e9; cursor: pointer; border-radius: 50%; border: 2px solid white; box-shadow: 0 0 5px rgba(0,0,0,0.2); }
        .hidden { display: none; }
        .flex { display: flex; }
        .modal-overlay { transition: opacity 0.3s ease; }
        .modal-content { transition: transform 0.3s ease, opacity 0.3s ease; }
        @keyframes fade-in-up { from { transform: translateY(20px) scale(0.95); opacity: 0; } to { transform: translateY(0) scale(1); opacity: 1; } }
        .animate-fade-in-up { animation: fade-in-up 0.3s ease-out forwards; }
        .loading-spinner { border: 4px solid rgba(255, 255, 255, 0.3); border-left-color: #ffffff; border-radius: 50%; width: 24px; height: 24px; animation: spin 1s linear infinite; }
        @keyframes spin { to { transform: rotate(360deg); } }
        .en-text { color: #64748b; font-size: 0.875rem; margin-top: -0.25rem; }
    </style>
</head>
<body class="bg-slate-100 text-slate-800">

    <div id="app" class="container mx-auto p-4 md:p-8 max-w-5xl">
        <div id="modal" class="fixed inset-0 bg-black bg-opacity-60 items-center justify-center z-50 hidden modal-overlay">
            <div class="bg-white p-6 rounded-lg shadow-xl w-11/12 max-w-md transform scale-95 opacity-0 modal-content">
                <h2 id="modal-title" class="text-2xl font-bold text-slate-800 mb-1"></h2>
                <p id="modal-title-en" class="en-text -mt-1 mb-4"></p>
                <div id="modal-body" class="text-slate-600 space-y-2"></div>
                <div class="text-right mt-6">
                    <button id="modal-close-btn" class="bg-sky-600 text-white font-bold py-2 px-6 rounded-lg hover:bg-sky-700 transition">關閉 <span class="text-sky-200 ml-1">Close</span></button>
                </div>
            </div>
        </div>
        <div id="success-modal" class="fixed inset-0 bg-black bg-opacity-60 items-center justify-center z-50 hidden">
            <div class="bg-white p-8 rounded-lg shadow-xl text-center transform transition-all scale-95 opacity-0 animate-fade-in-up">
                <h2 class="text-3xl font-bold text-green-600">成交！</h2>
                <p class="en-text text-green-500">Deal!</p>
                <p class="text-lg mt-2 text-slate-700">這工程有勞你了！</p>
                <p class="en-text">We're counting on you for this project!</p>
            </div>
        </div>
        <header class="text-center mb-8">
            <h1 class="text-3xl md:text-4xl font-bold text-slate-900">談判思維刻意練習場</h1>
            <p class="en-text -mt-1">Negotiation Sandbox</p>
            <p class="text-slate-600 mt-2">在模擬場景中，磨練您的談判技巧</p>
            <p class="en-text">Hone your negotiation skills in a simulated environment</p>
        </header>

        <div id="start-screen" class="screen active space-y-6">
            <div class="bg-white p-6 rounded-lg shadow-md">
                <h2 class="text-2xl font-bold mb-1">場景設定：商業綜合體總承包</h2>
                <p class="en-text -mt-1 mb-4 border-b pb-2">Scenario: General Contractor for a Commercial Complex</p>
                <p>您將扮演 <span class="font-bold text-sky-600">承包商 (Contractor)</span>，與 AI 扮演的 <span class="font-bold text-red-600">業主 (Client)</span> 就一個新的商業綜合體建設項目進行總承包談判。您的核心利益參數和談判底線（BATNA）如下：</p>
                <p class="en-text">You will play as the <span class="font-bold text-sky-600">Contractor</span>, negotiating with an AI <span class="font-bold text-red-600">Client</span> for a new commercial complex project. Your core interests and BATNA are as follows:</p>
            </div>
            <div class="grid md:grid-cols-2 gap-6">
                <div class="bg-white p-6 rounded-lg shadow-md">
                    <h3 class="text-xl font-bold mb-1">您的核心利益參數</h3>
                    <p class="en-text -mt-1 mb-4">Your Core Interests</p>
                    <ul class="space-y-3">
                        <li><strong>總造價 (Total Cost)</strong>: 期望 <span class="text-green-600">10,500,000</span> | 底線 <span class="text-red-600">9,000,000</span></li>
                        <li><strong>工期 (Duration)</strong>: 期望 <span class="text-green-600">330</span> 天 | 底線 <span class="text-red-600">240</span> 天</li>
                        <li><strong>保修期 (Warranty)</strong>: 期望 <span class="text-green-600">1</span> 年 | 底線 <span class="text-red-600">4</span> 年</li>
                        <li><strong>預付款 (Prepayment)</strong>: 期望 <span class="text-green-600">25</span>% | 底線 <span class="text-red-600">15</span>%</li>
                        <li><strong>附加義務等級 (Obligation Level)</strong>: 期望 <span class="text-green-600">1 (輕度)</span> | 底線 <span class="text-red-600">4 (重度)</span></li>
                    </ul>
                </div>
                <div class="bg-white p-6 rounded-lg shadow-md">
                    <h3 class="text-xl font-bold mb-1">您的 BATNA (最佳替代方案)</h3>
                    <p class="en-text -mt-1 mb-4">Your BATNA (Best Alternative to a Negotiated Agreement)</p>
                    <div class="bg-amber-100 border-l-4 border-amber-500 text-amber-800 p-4 rounded-r-lg">
                        <p>接受另一個住宅項目合約 (Accept another residential project contract):</p>
                        <ul class="list-disc list-inside mt-2">
                            <li>報價 (Price): 9,500,000 元</li>
                            <li>工期 (Duration): 300 天</li>
                            <li>保修期 (Warranty): 2 年</li>
                            <li>預付款 (Prepayment): 15%</li>
                            <li>附加義務 (Obligation): 等級 2 (一般/General)</li>
                        </ul>
                    </div>
                </div>
            </div>
            <div class="bg-white p-6 rounded-lg shadow-md">
                <h3 class="text-xl font-bold mb-1">附加義務等級定義</h3>
                <p class="en-text -mt-1 mb-4">Obligation Level Definitions</p>
                <div id="obligation-definitions-start" class="text-sm space-y-2 text-slate-600"></div>
            </div>
            <div class="bg-white p-6 rounded-lg shadow-md">
                <h2 class="text-2xl font-bold mb-1 text-center">開局信息</h2>
                <p class="en-text text-center -mt-1 mb-4">Initial Information</p>
                <div id="info-box" class="bg-sky-100 border-t-4 border-sky-500 rounded-b text-sky-900 px-4 py-3 shadow-md" role="alert"><div class="flex"><div class="py-1"><svg class="fill-current h-6 w-6 text-sky-500 mr-4" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20"><path d="M2.93 17.07A10 10 0 1 1 17.07 2.93 10 10 0 0 1 2.93 17.07zM9 11v4h2v-4H9zm0-4h2v2H9V7z"/></svg></div><div>
                    <p class="font-bold">本次 AI 業主的談判風格為：<span id="ai-style-info" class="text-red-600"></span></p>
                    <p class="en-text">This round's AI Client negotiation style: <span id="ai-style-info-en" class="text-red-600"></span></p>
                    <p class="text-sm mt-2" id="ai-leaked-info"></p>
                </div></div></div>
            </div>
            <div class="text-center">
                <button id="start-game-btn" class="bg-sky-600 text-white font-bold py-3 px-8 rounded-lg shadow-lg hover:bg-sky-700 transition-transform transform hover:scale-105 disabled:bg-slate-400" disabled>
                    正在載入... <span class="text-sky-200 ml-1">Loading...</span>
                </button>
            </div>
        </div>
        
        <div id="game-screen" class="screen"><div class="grid lg:grid-cols-3 gap-6"><div class="lg:col-span-2 bg-white p-6 rounded-lg shadow-md">
            <div class="flex justify-between items-center mb-6 border-b pb-3">
                <div>
                    <h2 class="text-2xl font-bold mb-1">您的方案</h2>
                    <p class="en-text -mt-1">Your Offer</p>
                </div>
                <div class="text-center">
                    <p class="text-sm text-slate-500">剩餘時間 (Time Left)</p>
                    <div id="timer" class="text-2xl font-bold text-red-600">05:00</div>
                </div>
            </div>
            <div id="negotiation-form" class="space-y-6"><div><label for="cost" class="flex justify-between font-medium"><span>總造價 (Total Cost)</span><span id="cost-value" class="font-bold text-sky-600"></span></label><input type="range" id="cost" min="8500000" max="11000000" step="50000" value="10500000"></div><div><label for="duration" class="flex justify-between font-medium"><span>工期 (Duration)</span><span id="duration-value" class="font-bold text-sky-600"></span></label><input type="range" id="duration" min="200" max="350" step="5" value="330"></div><div><label for="warranty" class="flex justify-between font-medium"><span>保修期 (Warranty)</span><span id="warranty-value" class="font-bold text-sky-600"></span></label><input type="range" id="warranty" min="1" max="5" step="1" value="1"></div><div><label for="prepayment" class="flex justify-between font-medium"><span>預付款 (Prepayment)</span><span id="prepayment-value" class="font-bold text-sky-600"></span></label><input type="range" id="prepayment" min="10" max="30" step="1" value="25"></div><div><label for="obligation" class="flex justify-between font-medium"><span>附加義務等級 (Obligation Level)</span><span id="obligation-value" class="font-bold text-sky-600"></span></label><input type="range" id="obligation" min="1" max="5" step="1" value="1"><div id="obligation-description-game" class="mt-2 text-sm bg-slate-100 p-3 rounded-md text-slate-700"></div></div></div><div class="mt-8 flex flex-wrap gap-4 items-center"><button id="submit-offer-btn" class="bg-sky-600 text-white font-bold py-2 px-6 rounded-lg hover:bg-sky-700 transition disabled:bg-slate-400 flex items-center justify-center gap-2">提交方案 <span class="text-sky-200">Submit</span></button><button id="end-negotiation-btn" class="bg-red-500 text-white font-bold py-2 px-6 rounded-lg hover:bg-red-600 transition">放棄談判 <span class="text-red-200">End</span></button></div></div><div class="space-y-6"><div class="bg-white p-4 rounded-lg shadow-md">
            <h3 class="text-lg font-bold mb-1">業主 (AI) 回應</h3>
            <p class="en-text -mt-1 mb-3">Client (AI) Response</p>
            <div id="ai-response" class="min-h-[100px] bg-slate-100 p-3 rounded-md text-slate-700 italic">
                等待您提交第一個方案...
                <p class="en-text">Waiting for your first offer...</p>
            </div>
        </div><div class="bg-white p-4 rounded-lg shadow-md">
            <h3 class="text-lg font-bold mb-1">您的底線</h3>
            <p class="en-text -mt-1 mb-3">Your Bottom Line</p>
            <button id="view-batna-btn" class="w-full bg-amber-500 text-white font-bold py-2 px-4 rounded-lg hover:bg-amber-600 transition">查看我的 BATNA <span class="text-amber-200">View My BATNA</span></button>
        </div></div></div></div>

        <div id="report-screen" class="screen space-y-6"><div id="result-summary" class="p-6 rounded-lg shadow-md text-center"><h2 id="result-title" class="text-4xl font-bold mb-2"></h2><p id="result-text" class="text-lg"></p><p class="text-md text-slate-600 mt-2">本次業主的談判風格為 (Client's negotiation style): <span id="report-ai-style" class="font-bold"></span></p></div><div class="bg-white p-6 rounded-lg shadow-md">
            <h3 class="text-xl font-bold mb-1">最終方案對比</h3>
            <p class="en-text -mt-1 mb-4">Final Offer Comparison</p>
            <div class="overflow-x-auto"><table class="w-full text-sm text-left"><thead class="bg-slate-100"><tr>
                <th class="p-3">參數<p class="en-text font-normal">Parameter</p></th>
                <th class="p-3 text-sky-600">您的最終方案<p class="en-text font-normal">Your Final Offer</p></th>
                <th class="p-3 text-green-600">您的期望<p class="en-text font-normal">Your Expectation</p></th>
                <th class="p-3 text-red-600">您的底線<p class="en-text font-normal">Your Reserve</p></th>
                <th class="p-3 text-red-600">業主底線<p class="en-text font-normal">Client's Reserve</p></th>
                <th class="p-3 text-green-600">業主期望<p class="en-text font-normal">Client's Expectation</p></th>
            </tr></thead><tbody id="report-table-body"></tbody></table></div></div><div class="grid md:grid-cols-3 gap-6"><div class="md:col-span-2 bg-white p-6 rounded-lg shadow-md">
            <h3 class="text-xl font-bold mb-1">"成交區間"可視化分析 (ZOPA)</h3>
            <p class="en-text -mt-1 mb-4">Zone of Possible Agreement (ZOPA) Analysis</p>
            <div id="deal-zone-analysis" class="space-y-2"></div></div><div class="space-y-6"><div class="bg-white p-6 rounded-lg shadow-md">
            <h3 class="text-xl font-bold mb-1">行為統計</h3>
            <p class="en-text -mt-1 mb-4">Behavior Statistics</p>
            <ul id="behavior-stats" class="space-y-2"></ul></div><div class="bg-white p-6 rounded-lg shadow-md">
            <h3 class="text-xl font-bold mb-1">雙方滿意度評估</h3>
            <p class="en-text -mt-1 mb-4">Satisfaction Score</p>
            <div id="satisfaction-scores" class="space-y-2"></div></div></div></div><div class="bg-white p-6 rounded-lg shadow-md">
            <h3 class="text-xl font-bold mb-1">智能提示</h3>
            <p class="en-text -mt-1 mb-4">Smart Tips</p>
            <div id="smart-tips" class="bg-sky-100 border-l-4 border-sky-500 text-sky-800 p-4 rounded-r-lg space-y-2"></div></div><div class="text-center mt-6"><button id="next-round-btn" class="bg-sky-600 text-white font-bold py-3 px-8 rounded-lg shadow-lg hover:bg-sky-700 transition-transform transform hover:scale-105">下一輪 <span class="text-sky-200">Next Round</span></button><button id="view-summary-btn" class="bg-purple-600 text-white font-bold py-3 px-8 rounded-lg shadow-lg hover:bg-purple-700 transition-transform transform hover:scale-105 hidden">查看最終總結 <span class="text-purple-200">View Final Summary</span></button></div></div>

        <div id="final-summary-screen" class="screen space-y-6">
            <div class="bg-white p-6 rounded-lg shadow-md text-center">
                <h2 class="text-3xl font-bold text-slate-800">系列談判總結</h2>
                <p class="en-text">Series Negotiation Summary</p>
                <p class="text-slate-600 mt-2">您已完成所有談判風格的挑戰，以下是您的成績總覽。</p>
                <p class="en-text">You have completed all negotiation style challenges. Here is your performance summary.</p>
            </div>
             <div class="bg-white p-6 rounded-lg shadow-md">
                <div id="final-score-container" class="text-center mb-4">
                    <h3 class="text-xl font-bold mb-1">談判練習總分</h3>
                    <p class="en-text -mt-1 mb-2">Final Negotiation Score</p>
                    <p id="final-score" class="text-5xl font-bold text-sky-600"></p>
                    <p id="final-score-logic" class="text-sm text-slate-500 mt-2"></p>
                </div>
                <div class="overflow-x-auto">
                    <table class="w-full text-sm text-left">
                        <thead class="bg-slate-100">
                            <tr>
                                <th class="p-3">談判風格<p class="en-text font-normal">Style</p></th>
                                <th class="p-3">結果<p class="en-text font-normal">Result</p></th>
                                <th class="p-3">成交方案<p class="en-text font-normal">Deal Terms</p></th>
                                <th class="p-3">對話輪次<p class="en-text font-normal">Rounds</p></th>
                                <th class="p-3">BATNA 查看<p class="en-text font-normal">BATNA Views</p></th>
                                <th class="p-3">過度讓步<p class="en-text font-normal">Over-concessions</p></th>
                                <th class="p-3">非理性思考<p class="en-text font-normal">Irrational Moves</p></th>
                                <th class="p-3">您的滿意度<p class="en-text font-normal">Your Score</p></th>
                                <th class="p-3">業主滿意度<p class="en-text font-normal">Client's Score</p></th>
                            </tr>
                        </thead>
                        <tbody id="final-summary-table-body">
                            <!-- Summary rows will be injected by JS -->
                        </tbody>
                    </table>
                </div>
            </div>
            <div class="text-center mt-6">
                <button id="restart-series-btn" class="bg-sky-600 text-white font-bold py-3 px-8 rounded-lg shadow-lg hover:bg-sky-700 transition-transform transform hover:scale-105">重新開始新系列 <span class="text-sky-200">Restart Series</span></button>
            </div>
        </div>
    </div>

<script>
document.addEventListener('DOMContentLoaded', () => {
    const screens = { start: document.getElementById('start-screen'), game: document.getElementById('game-screen'), report: document.getElementById('report-screen'), finalSummary: document.getElementById('final-summary-screen') };
    const buttons = { startGame: document.getElementById('start-game-btn'), submitOffer: document.getElementById('submit-offer-btn'), endNegotiation: document.getElementById('end-negotiation-btn'), viewBatna: document.getElementById('view-batna-btn'), nextRound: document.getElementById('next-round-btn'), viewSummary: document.getElementById('view-summary-btn'), restartSeries: document.getElementById('restart-series-btn'), modalClose: document.getElementById('modal-close-btn') };
    const inputs = { cost: document.getElementById('cost'), duration: document.getElementById('duration'), warranty: document.getElementById('warranty'), prepayment: document.getElementById('prepayment'), obligation: document.getElementById('obligation') };
    const displays = {
        costValue: document.getElementById('cost-value'), durationValue: document.getElementById('duration-value'), warrantyValue: document.getElementById('warranty-value'), prepaymentValue: document.getElementById('prepayment-value'), obligationValue: document.getElementById('obligation-value'),
        obligationDescGame: document.getElementById('obligation-description-game'), obligationDefsStart: document.getElementById('obligation-definitions-start'), aiResponse: document.getElementById('ai-response'), 
        aiStyleInfo: document.getElementById('ai-style-info'), aiStyleInfoEn: document.getElementById('ai-style-info-en'), aiLeakedInfo: document.getElementById('ai-leaked-info'),
        resultTitle: document.getElementById('result-title'), resultText: document.getElementById('result-text'), reportAiStyle: document.getElementById('report-ai-style'), reportTableBody: document.getElementById('report-table-body'),
        dealZoneAnalysis: document.getElementById('deal-zone-analysis'), behaviorStats: document.getElementById('behavior-stats'), satisfactionScores: document.getElementById('satisfaction-scores'), smartTips: document.getElementById('smart-tips'),
        successModal: document.getElementById('success-modal'), modal: document.getElementById('modal'), modalTitle: document.getElementById('modal-title'), modalTitleEn: document.getElementById('modal-title-en'), modalBody: document.getElementById('modal-body'),
        infoBox: document.getElementById('info-box'),
        finalSummaryTableBody: document.getElementById('final-summary-table-body'),
        timer: document.getElementById('timer'),
        finalScore: document.getElementById('final-score'),
        finalScoreLogic: document.getElementById('final-score-logic'),
    };
    
    let gameStateToken = null;
    let timerInterval = null;
    let lastSubmitTimestamp = 0;

    const OBLIGATION_LEVELS = { 1: { name: '輕度義務', en_name: 'Light' }, 2: { name: '一般義務', en_name: 'General' }, 3: { name: '中度義務', en_name: 'Moderate' }, 4: { name: '重度義務', en_name: 'Heavy' }, 5: { name: '全面義務', en_name: 'Comprehensive' } };
    const OBLIGATION_DEFS = { 
        1: '配合標準審計流程，提供常規進度報告。<p class="en-text">Cooperate with standard audit procedures, provide regular progress reports.</p>', 
        2: '除標準報告外，需提供額外的專項報告（如環保、安全）。<p class="en-text">In addition to standard reports, provide extra special reports (e.g., environmental, safety).</p>', 
        3: '需承擔與所有由業主直接指定的分包商的協調管理責任。<p class="en-text">Assume coordination and management responsibility for all subcontractors directly appointed by the client.</p>', 
        4: '需承擔因非承包商原因導致的部分設計變更（累計不超過合約價5%）所引發的現場管理成本。<p class="en-text">Bear site management costs for partial design changes (not exceeding 5% of contract value) not caused by the contractor.</p>', 
        5: '需承擔項目範圍內全部未知地質條件、以及因極端天氣導致的工期延誤風險。<p class="en-text">Assume risks for all unknown geological conditions and project delays due to extreme weather.</p>'
    };
    
    async function apiCall(action, payload = {}) {
        try {
            const response = await fetch('/api/negotiate', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ action, ...payload }),
            });
            const contentType = response.headers.get("content-type");
            if (!contentType || !contentType.includes("application/json")) {
                 throw new Error("伺服器返回了無效的回應格式(不是JSON)。這很可能是因為預覽環境無法執行後端程式碼，請在部署後測試。\n\nServer returned an invalid format (not JSON). This is likely because the preview environment cannot execute backend code. Please test after deployment.");
            }
            const data = await response.json();
            if (!response.ok) throw new Error(data.details || `伺服器錯誤 (Server Error): ${response.status}`);
            return data;
        } catch (error) {
            console.error('API call failed:', error);
            alert(`與伺服器通信失敗，請刷新頁面重試。\nCommunication with the server failed, please refresh and try again.\n\n錯誤詳情 (Error Details): ${error.message}`);
            return null;
        }
    }

    function switchScreen(screenName) { Object.values(screens).forEach(s => s.classList.remove('active')); screens[screenName].classList.add('active'); }
    function showModal(title, title_en, bodyHTML) { 
        displays.modal.classList.remove('hidden'); displays.modal.classList.add('flex'); 
        displays.modalTitle.textContent = title; 
        displays.modalTitleEn.textContent = title_en;
        displays.modalBody.innerHTML = bodyHTML; 
        setTimeout(() => { if (displays.modal.querySelector('.modal-content')) displays.modal.querySelector('.modal-content').classList.remove('scale-95', 'opacity-0'); }, 10); 
    }
    function hideModal() { if (displays.modal.querySelector('.modal-content')) displays.modal.querySelector('.modal-content').classList.add('scale-95', 'opacity-0'); setTimeout(() => {displays.modal.classList.add('hidden'); displays.modal.classList.remove('flex');}, 300); }
    function updateSliderValue(key, value) {
        let displayValue = value;
        if (key === 'cost') { displayValue = parseInt(value).toLocaleString(); } 
        else if (key === 'obligation') {
            if (OBLIGATION_LEVELS[value]) {
                displayValue = `${value} (${OBLIGATION_LEVELS[value].name} / ${OBLIGATION_LEVELS[value].en_name})`;
                displays.obligationDescGame.innerHTML = `等級 ${value}: ${OBLIGATION_DEFS[value]}`;
            }
        }
        if (displays[`${key}Value`]) displays[`${key}Value`].textContent = displayValue;
    }
    function toggleButtonLoading(button, isLoading) {
        if (!button) return;
        if (isLoading) {
            button.disabled = true;
            button.dataset.originalText = button.innerHTML;
            button.innerHTML = `<div class="loading-spinner"></div>`;
        } else {
            button.disabled = false;
            if (button.dataset.originalText) button.innerHTML = button.dataset.originalText;
        }
    }

    function stopTimer() {
        clearInterval(timerInterval);
        timerInterval = null;
    }

    function startTimer() {
        stopTimer(); 
        let timeLeft = 300; // 5 minutes
        displays.timer.textContent = "05:00";

        timerInterval = setInterval(() => {
            timeLeft--;
            const minutes = Math.floor(timeLeft / 60);
            const seconds = timeLeft % 60;
            displays.timer.textContent = `${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;
            if (timeLeft <= 0) {
                stopTimer();
                alert("時間到！談判自動結束。\nTime's up! The negotiation has ended automatically.");
                handleEndNegotiation();
            }
        }, 1000);
    }
    
    async function init(token = null) {
        switchScreen('start');
        toggleButtonLoading(buttons.startGame, true);
        
        const data = await apiCall('init', { token });
        
        if (data) {
            if(data.isGameOver) {
                renderFinalSummary(data.gameHistory, data.finalScore);
                return;
            }
            gameStateToken = data.token;
            displays.aiStyleInfo.textContent = data.aiStyleName;
            displays.aiStyleInfoEn.textContent = data.aiStyleEnName;
            displays.aiLeakedInfo.innerHTML = data.leakedInfoHTML;
            
            for (const key in data.initialOffer) {
                if (inputs[key]) inputs[key].value = data.initialOffer[key];
            }

            toggleButtonLoading(buttons.startGame, false);
        }

        displays.obligationDefsStart.innerHTML = Object.entries(OBLIGATION_DEFS).map(([i, desc]) => `<p><span class="font-bold">等級 ${i} (${OBLIGATION_LEVELS[i].name} / ${OBLIGATION_LEVELS[i].en_name}):</span> ${desc}</p>`).join('');
        
        for (const key in inputs) {
            if(inputs[key]) updateSliderValue(key, inputs[key].value);
        }
        displays.aiResponse.innerHTML = '等待您提交第一個方案...<p class="en-text">Waiting for your first offer...</p>';
    }

    async function handleSubmitOffer() {
        const now = Date.now();
        if (now - lastSubmitTimestamp < 30000) {
            showModal(
                '提交過於頻繁！',
                'Submission Too Frequent!',
                `<p>你家不是開銀行的，請你仔細思考後再提出方案！</p><p class="en-text">Your family doesn't own a bank, please think carefully before making another offer!</p><p class="mt-2 text-sm text-amber-700">（此行為已被記錄為一次「非理性思考」）<br><span class="en-text">(This action has been recorded as one "irrational move")</span></p>`
            );
            const data = await apiCall('irrationalMove', { token: gameStateToken });
            if (data) gameStateToken = data.token;
            return;
        }

        lastSubmitTimestamp = now;
        toggleButtonLoading(buttons.submitOffer, true);
        const offer = Object.fromEntries(Object.entries(inputs).map(([key, input]) => [key, parseInt(input.value)]));
        const data = await apiCall('submit', { token: gameStateToken, offer });
        if (data) {
            gameStateToken = data.token;
            if (data.isDeal) {
                stopTimer();
                showSuccessAndReport(data.reportData);
            } else {
                displays.aiResponse.innerHTML = data.aiResponseHTML;
            }
        }
        toggleButtonLoading(buttons.submitOffer, false);
    }

    function showSuccessAndReport(reportData) {
        displays.successModal.classList.remove('hidden');
        displays.successModal.classList.add('flex');
        setTimeout(() => { if (displays.successModal.querySelector('div')) displays.successModal.querySelector('div').classList.remove('scale-95', 'opacity-0'); }, 10);
        setTimeout(() => {
            if (displays.successModal.querySelector('div')) displays.successModal.querySelector('div').classList.add('scale-95', 'opacity-0');
            setTimeout(() => {
                displays.successModal.classList.add('hidden');
                displays.successModal.classList.remove('flex');
                renderReport(reportData);
            }, 300);
        }, 2500);
    }
    
    async function handleEndNegotiation() {
        stopTimer();
        const offer = Object.fromEntries(Object.entries(inputs).map(([key, input]) => [key, parseInt(input.value)]));
        const data = await apiCall('end', { token: gameStateToken, offer });
        if (data) {
             gameStateToken = data.token;
             renderReport(data.reportData);
        }
    }

    function renderReport(data) {
        displays.resultTitle.textContent = data.isSuccess ? '談判成功！' : '談判破裂';
        displays.resultText.innerHTML = data.resultText;
        displays.reportAiStyle.innerHTML = data.aiStyleName;
        displays.reportTableBody.innerHTML = data.reportTableHTML;
        displays.dealZoneAnalysis.innerHTML = data.dealZoneAnalysisHTML;
        displays.behaviorStats.innerHTML = data.behaviorStatsHTML;
        displays.satisfactionScores.innerHTML = data.satisfactionScoresHTML;
        displays.smartTips.innerHTML = data.smartTipsHTML;
        
        if (data.isGameOver) {
            buttons.nextRound.classList.add('hidden');
            buttons.viewSummary.classList.remove('hidden');
            buttons.viewSummary.onclick = () => renderFinalSummary(data.gameHistory, data.finalScore);
        } else {
            buttons.nextRound.classList.remove('hidden');
            buttons.viewSummary.classList.add('hidden');
        }
        
        switchScreen('report');
    }

    function renderFinalSummary(gameHistory, finalScore) {
        displays.finalScore.textContent = `${finalScore.score} / 100`;
        displays.finalScoreLogic.innerHTML = finalScore.logic;
        displays.finalSummaryTableBody.innerHTML = gameHistory.map(round => {
            const resultClass = round.isSuccess ? 'text-green-600' : 'text-red-600';
            const userScore = round.satisfaction.user !== '--' ? `${round.satisfaction.user} / 10` : '--';
            const aiScore = round.satisfaction.ai !== '--' ? `${round.satisfaction.ai} / 10` : '--';
            
            const dealTerms = round.isSuccess && round.finalOffer 
                ? `造價: ${round.finalOffer.cost.toLocaleString()} 元<br><span class="en-text">Cost: ${round.finalOffer.cost.toLocaleString()}</span><br>工期: ${round.finalOffer.duration} 天<br><span class="en-text">Duration: ${round.finalOffer.duration} Days</span>`
                : '--';

            const overConcessionCount = round.satisfaction.penaltyReasons ? round.satisfaction.penaltyReasons.length : 0;

            return `<tr class="border-b">
                <td class="p-3 font-medium">${round.styleName}<p class="en-text">${round.en_styleName}</p></td>
                <td class="p-3 font-bold ${resultClass}">${round.isSuccess ? '談成' : '破裂'}<p class="en-text font-normal">${round.isSuccess ? 'Deal' : 'No Deal'}</p></td>
                <td class="p-3 text-sm">${dealTerms}</td>
                <td class="p-3 text-center">${round.offersSubmitted}</td>
                <td class="p-3 text-center">${round.batnaViews}</td>
                <td class="p-3 text-center text-amber-600 font-bold">${overConcessionCount}</td>
                <td class="p-3 text-center text-red-600 font-bold">${round.irrationalMoves}</td>
                <td class="p-3">${userScore}</td>
                <td class="p-3">${aiScore}</td>
            </tr>`;
        }).join('');
        switchScreen('finalSummary');
    }

    buttons.startGame.addEventListener('click', () => { 
        lastSubmitTimestamp = Date.now(); // Reset timestamp for the new round
        switchScreen('game'); 
        startTimer();
    });
    buttons.submitOffer.addEventListener('click', handleSubmitOffer);
    buttons.endNegotiation.addEventListener('click', handleEndNegotiation);
    buttons.nextRound.addEventListener('click', () => init(gameStateToken));
    buttons.restartSeries.addEventListener('click', () => init(null));
    buttons.viewBatna.addEventListener('click', () => {
        apiCall('viewBatna', { token: gameStateToken }).then(data => { if (data) gameStateToken = data.token; });
        const batnaHTML = `<p class="font-bold">您的最佳替代方案是一個住宅項目合約，其價值可量化為：</p><p class="en-text">Your best alternative is a residential project contract, quantifiable as:</p><ul class="list-disc list-inside mt-2 space-y-1 text-slate-700"><li><strong>報價 (Price):</strong> 9,500,000 元</li><li><strong>工期 (Duration):</strong> 300 天</li><li><strong>保修期 (Warranty):</strong> 2 年</li><li><strong>預付款 (Prepayment):</strong> 15%</li><li><strong>附加義務 (Obligation):</strong> 等級 2 (一般義務 / General)</li></ul><p class="mt-4 text-sm bg-amber-100 p-2 rounded">當前談判的條件若劣於此方案，您應當選擇放棄。<br><span class="text-amber-700">If the current negotiation terms are worse than this alternative, you should walk away.</span></p>`;
        showModal('您的 BATNA (最佳替代方案)', 'Your BATNA (Best Alternative to a Negotiated Agreement)', batnaHTML);
    });
    buttons.modalClose.addEventListener('click', hideModal);
    Object.entries(inputs).forEach(([key, input]) => { if (input) input.addEventListener('input', (e) => updateSliderValue(key, e.target.value)); });

    init(null);
});
</script>

</body>
</html>

