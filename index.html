<!DOCTYPE html>
<html lang="zh-Hant">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>情境談判模擬沙盒 / Scenario Negotiation Sandbox</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@400;500;700&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Noto Sans TC', sans-serif; }
        .screen { display: none; }
        .screen.active { display: block; }
        input[type=range] { -webkit-appearance: none; appearance: none; width: 100%; height: 8px; background: #d3d3d3; outline: none; opacity: 0.7; transition: opacity .2s; border-radius: 5px; }
        input[type=range]:hover { opacity: 1; }
        input[type=range]::-webkit-slider-thumb { -webkit-appearance: none; appearance: none; width: 20px; height: 20px; background: #0ea5e9; cursor: pointer; border-radius: 50%; border: 2px solid white; box-shadow: 0 0 5px rgba(0,0,0,0.2); }
        input[type=range]::-moz-range-thumb { width: 20px; height: 20px; background: #0ea5e9; cursor: pointer; border-radius: 50%; border: 2px solid white; box-shadow: 0 0 5px rgba(0,0,0,0.2); }
        .hidden { display: none; }
        .flex { display: flex; }
        .modal-overlay { transition: opacity 0.3s ease; }
        .modal-content { transition: transform 0.3s ease, opacity 0.3s ease; }
        @keyframes fade-in-up { from { transform: translateY(20px) scale(0.95); opacity: 0; } to { transform: translateY(0) scale(1); opacity: 1; } }
        .animate-fade-in-up { animation: fade-in-up 0.3s ease-out forwards; }
        .loading-spinner { border: 4px solid rgba(255, 255, 255, 0.3); border-left-color: #ffffff; border-radius: 50%; width: 24px; height: 24px; animation: spin 1s linear infinite; }
        @keyframes spin { to { transform: rotate(360deg); } }
        .en-text { color: #64748b; font-size: 0.875rem; margin-top: -0.25rem; }
    </style>
</head>
<body class="bg-slate-100 text-slate-800">

    <div id="app" class="container mx-auto p-4 md:p-8 max-w-5xl">
        
        <div id="modal" class="fixed inset-0 bg-black bg-opacity-60 items-center justify-center z-50 hidden modal-overlay">
            <div class="bg-white p-6 rounded-lg shadow-xl w-11/12 max-w-md transform scale-95 opacity-0 modal-content">
                <h2 id="modal-title" class="text-2xl font-bold text-slate-800 mb-1"></h2>
                <p id="modal-title-en" class="en-text -mt-1 mb-4"></p>
                <div id="modal-body" class="text-slate-600 space-y-2"></div>
                <div class="text-right mt-6">
                    <button id="modal-close-btn" class="bg-sky-600 text-white font-bold py-2 px-6 rounded-lg hover:bg-sky-700 transition">關閉 <span class="text-sky-200 ml-1">Close</span></button>
                </div>
            </div>
        </div>

        <div id="success-modal" class="fixed inset-0 bg-black bg-opacity-60 items-center justify-center z-50 hidden">
            <div class="bg-white p-8 rounded-lg shadow-xl text-center transform transition-all scale-95 opacity-0 animate-fade-in-up">
                <h2 id="success-modal-title" class="text-3xl font-bold text-green-600"></h2>
                <p id="success-modal-title-en" class="en-text text-green-500"></p>
                <p id="success-modal-text" class="text-lg mt-2 text-slate-700"></p>
                <p id="success-modal-text-en" class="en-text"></p>
            </div>
        </div>

        <header class="text-center mb-8">
            <h1 class="text-3xl md:text-4xl font-bold text-slate-900">情境談判模擬沙盒</h1>
            <p class="en-text -mt-1">Scenario Negotiation Sandbox</p>
            <p class="text-slate-600 mt-2">在模擬場景中，磨練您的談判技巧</p>
            <p class="en-text">Hone your negotiation skills in a simulated environment</p>
        </header>

        <div id="instruction-screen" class="screen active space-y-6">
            <div class="bg-white p-6 rounded-lg shadow-md">
                <h2 class="text-2xl font-bold mb-1">歡迎來到談判練習場</h2>
                <p class="en-text -mt-1 mb-4">Welcome to the Negotiation Sandbox</p>
                <div class="space-y-4">
                    <div>
                        <h3 class="text-lg font-bold text-sky-700">遊戲目標 (Game Goal)</h3>
                        <p class="text-slate-600 mt-1">本遊戲旨在幫您練習三大核心談判思維。您的 **BATNA** (最佳替代方案) 決定了您的談判底線；我方的底線與您的底線共同構成了 **ZOPA** (可能成交區間)，所有成功的協議都在此發生；當 ZOPA 過於狹窄時，您需要利用 **Trade-on** (價值交換)，透過放棄次要利益來換取核心利益，從而達成協議。</p>
                        <p class="en-text text-slate-500">This game helps you practice three core negotiation concepts. Your **BATNA** determines your bottom line. The overlap between your bottom line and your opponent's forms the **ZOPA**, where all successful agreements happen. When the ZOPA is narrow, you must use **Trade-ons** (exchanging concessions on minor issues for gains on major ones) to create value and reach a deal.</p>
                    </div>
                    <div>
                        <h3 class="text-lg font-bold text-sky-700">行為準則 (Rules of Conduct)</h3>
                        <ul class="list-disc list-inside space-y-1 mt-1 text-slate-600">
                            <li><b>五輪挑戰 (Five Rounds Challenge):</b> 您將面對五位風格各異的對手，請盡力在每一輪中達成最佳協議。</li>
                            <li><b>時間壓力 (Time Pressure):</b> 每輪談判限時 **5 分鐘**，超時將導致談判破裂。</li>
                            <li><b>深思熟慮 (Think Carefully):</b> 兩次提交方案之間需間隔 **15 秒**。過於倉促的決策將被記錄為「非理性思考」。</li>
                            <li><b>避免過度讓步 (Avoid Over-concession):</b> 做出遠超對手期望的讓步會被記錄，並影響您的滿意度評分。</li>
                        </ul>
                    </div>
                </div>
            </div>
            <div class="text-center">
                <button id="go-to-theme-selection-btn" class="bg-sky-600 text-white font-bold py-3 px-8 rounded-lg shadow-lg hover:bg-sky-700 transition-transform transform hover:scale-105">
                    我明白了，請選擇模擬情境 <span class="text-sky-200 ml-1">I Understand, Please Select a Scenario</span>
                </button>
            </div>
        </div>

        <div id="theme-selection-screen" class="screen space-y-6">
            <div class="bg-white p-6 rounded-lg shadow-md text-center">
                <h2 class="text-2xl font-bold mb-1">請選擇一個談判情境</h2>
                <p class="en-text -mt-1 mb-4">Please Choose a Negotiation Scenario</p>
            </div>
            <div class="grid md:grid-cols-2 gap-6 text-center">
                <button data-theme="student" class="theme-btn bg-white p-6 rounded-lg shadow-md hover:shadow-xl hover:scale-105 transition-transform duration-300">
                    <h3 class="text-2xl font-bold text-sky-700">大學生情境</h3>
                    <p class="en-text">Student Scenarios</p>
                    <p class="mt-4 text-slate-600">模擬小組報告分工、爭取實習 Offer 等校園與職場銜接的談判挑戰。</p>
                    <p class="en-text text-slate-500">Simulate challenges like group projects and internship offer negotiations.</p>
                </button>
                <button data-theme="contractor" class="theme-btn bg-white p-6 rounded-lg shadow-md hover:shadow-xl hover:scale-105 transition-transform duration-300">
                    <h3 class="text-2xl font-bold text-emerald-700">營建業情境</h3>
                    <p class="en-text">Contractor Scenarios</p>
                    <p class="mt-4 text-slate-600">模擬辦公室裝修、商業綜合體總承包等工程領域的商業談判。</p>
                    <p class="en-text text-slate-500">Simulate business negotiations in construction, such as renovations and general contracting.</p>
                </button>
            </div>
        </div>

        <div id="scene-screen" class="screen space-y-6">
            <div class="bg-white p-6 rounded-lg shadow-md">
                <h2 id="scene-title" class="text-2xl font-bold mb-1"></h2>
                <p id="scene-title-en" class="en-text -mt-1 mb-4 border-b pb-2"></p>
                <p id="scene-description"></p>
                <p id="scene-description-en" class="en-text"></p>
            </div>
            <div class="grid md:grid-cols-2 gap-6">
                <div class="bg-white p-6 rounded-lg shadow-md">
                    <h3 class="text-xl font-bold mb-1">您的核心利益參數</h3>
                    <p class="en-text -mt-1 mb-4">Your Core Interests</p>
                    <ul id="scene-user-params" class="space-y-3"></ul>
                </div>
                <div class="bg-white p-6 rounded-lg shadow-md">
                    <h3 class="text-xl font-bold mb-1">您的 BATNA (最佳替代方案)</h3>
                    <p class="en-text -mt-1 mb-4">Your BATNA</p>
                    <div id="scene-user-batna" class="bg-amber-100 border-l-4 border-amber-500 text-amber-800 p-4 rounded-r-lg"></div>
                </div>
            </div>
            <div class="bg-white p-6 rounded-lg shadow-md">
                <h3 id="obligation-title" class="text-xl font-bold mb-1"></h3>
                <p id="obligation-title-en" class="en-text -mt-1 mb-4"></p>
                <div id="obligation-definitions-start" class="text-sm space-y-2 text-slate-600"></div>
            </div>
            <div class="bg-white p-6 rounded-lg shadow-md">
                <h2 class="text-2xl font-bold mb-1 text-center">開局信息</h2>
                <p class="en-text text-center -mt-1 mb-4">Initial Information</p>
                <div id="info-box" class="bg-sky-100 border-t-4 border-sky-500 rounded-b text-sky-900 px-4 py-3 shadow-md" role="alert"><div class="flex"><div class="py-1"><svg class="fill-current h-6 w-6 text-sky-500 mr-4" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20"><path d="M2.93 17.07A10 10 0 1 1 17.07 2.93 10 10 0 0 1 2.93 17.07zM9 11v4h2v-4H9zm0-4h2v2H9V7z"/></svg></div><div>
                    <p class="font-bold">本次 AI 對方的談判風格為：<span id="ai-style-info" class="text-red-600"></span></p>
                    <p class="en-text">This round's AI opponent negotiation style: <span id="ai-style-info-en" class="text-red-600"></span></p>
                    <p class="text-sm mt-2" id="ai-leaked-info"></p>
                </div></div></div>
            </div>
            <div class="text-center">
                <button id="start-game-btn" class="bg-sky-600 text-white font-bold py-3 px-8 rounded-lg shadow-lg hover:bg-sky-700 transition-transform transform hover:scale-105 disabled:bg-slate-400 flex items-center justify-center"></button>
            </div>
        </div>
        
        <div id="game-screen" class="screen"><div class="grid lg:grid-cols-3 gap-6"><div class="lg:col-span-2 bg-white p-6 rounded-lg shadow-md">
            <div class="flex justify-between items-center mb-6 border-b pb-3">
                <div>
                    <h2 class="text-2xl font-bold mb-1">您的方案</h2>
                    <p class="en-text -mt-1">Your Offer</p>
                </div>
                <div class="text-center">
                    <p class="text-sm text-slate-500">剩餘時間 (Time Left)</p>
                    <div id="timer" class="text-2xl font-bold text-red-600">05:00</div>
                </div>
            </div>
            <div id="negotiation-form" class="space-y-6"></div>
            <div class="mt-8 flex flex-wrap gap-4 items-center"><button id="submit-offer-btn" class="bg-sky-600 text-white font-bold py-2 px-6 rounded-lg hover:bg-sky-700 transition disabled:bg-slate-400 flex items-center justify-center gap-2">提交方案 <span class="text-sky-200">Submit</span></button><button id="end-negotiation-btn" class="bg-red-500 text-white font-bold py-2 px-6 rounded-lg hover:bg-red-600 transition">放棄談判 <span class="text-red-200">End</span></button></div></div><div class="space-y-6"><div class="bg-white p-4 rounded-lg shadow-md">
            <h3 id="ai-opponent-title" class="text-lg font-bold mb-1"></h3>
            <p id="ai-opponent-title-en" class="en-text -mt-1 mb-3"></p>
            <div id="ai-response" class="min-h-[100px] bg-slate-100 p-3 rounded-md text-slate-700 italic">
                等待您提交第一個方案...
                <p class="en-text">Waiting for your first offer...</p>
            </div>
        </div><div class="bg-white p-4 rounded-lg shadow-md">
            <h3 class="text-lg font-bold mb-1">您的底線</h3>
            <p class="en-text -mt-1 mb-3">Your Bottom Line</p>
            <button id="view-batna-btn" class="w-full bg-amber-500 text-white font-bold py-2 px-4 rounded-lg hover:bg-amber-600 transition">查看我的 BATNA <span class="text-amber-200">View My BATNA</span></button>
        </div></div></div></div>

        <div id="report-screen" class="screen space-y-6"><div id="result-summary" class="p-6 rounded-lg shadow-md text-center"><h2 id="result-title" class="text-4xl font-bold mb-2"></h2><p id="result-text" class="text-lg"></p><p class="text-md text-slate-600 mt-2">本次對方的談判風格為 (Opponent's negotiation style): <span id="report-ai-style" class="font-bold"></span></p></div><div class="bg-white p-6 rounded-lg shadow-md">
            <h3 class="text-xl font-bold mb-1">最終方案對比</h3>
            <p class="en-text -mt-1 mb-4">Final Offer Comparison</p>
            <div class="overflow-x-auto"><table class="w-full text-sm text-left"><thead id="report-table-head" class="bg-slate-100"></thead><tbody id="report-table-body"></tbody></table></div></div><div class="grid md:grid-cols-3 gap-6"><div class="md:col-span-2 bg-white p-6 rounded-lg shadow-md">
            <h3 class="text-xl font-bold mb-1">"成交區間"可視化分析 (ZOPA)</h3>
            <p class="en-text -mt-1 mb-4">Zone of Possible Agreement (ZOPA) Analysis</p>
            <div id="deal-zone-analysis" class="space-y-2"></div></div><div class="space-y-6"><div class="bg-white p-6 rounded-lg shadow-md">
            <h3 class="text-xl font-bold mb-1">行為統計</h3>
            <p class="en-text -mt-1 mb-4">Behavior Statistics</p>
            <ul id="behavior-stats" class="space-y-2"></ul></div><div class="bg-white p-6 rounded-lg shadow-md">
            <h3 class="text-xl font-bold mb-1">雙方滿意度評估</h3>
            <p class="en-text -mt-1 mb-4">Satisfaction Score</p>
            <div id="satisfaction-scores" class="space-y-2"></div></div></div></div><div class="bg-white p-6 rounded-lg shadow-md">
            <h3 class="text-xl font-bold mb-1">智能提示</h3>
            <p class="en-text -mt-1 mb-4">Smart Tips</p>
            <div id="smart-tips" class="bg-sky-100 border-l-4 border-sky-500 text-sky-800 p-4 rounded-r-lg space-y-2"></div></div><div class="text-center mt-6"><button id="next-round-btn" class="bg-sky-600 text-white font-bold py-3 px-8 rounded-lg shadow-lg hover:bg-sky-700 transition-transform transform hover:scale-105">下一輪 <span class="text-sky-200">Next Round</span></button><button id="view-summary-btn" class="bg-purple-600 text-white font-bold py-3 px-8 rounded-lg shadow-lg hover:bg-purple-700 transition-transform transform hover:scale-105 hidden">查看最終總結 <span class="text-purple-200">View Final Summary</span></button></div></div>

        <div id="final-summary-screen" class="screen space-y-6">
            <div class="bg-white p-6 rounded-lg shadow-md text-center">
                <h2 class="text-3xl font-bold text-slate-800">系列談判總結</h2>
                <p class="en-text">Series Negotiation Summary</p>
                <p class="text-slate-600 mt-2">您已完成所有談判風格的挑戰，以下是您的成績總覽。</p>
                <p class="en-text">You have completed all negotiation style challenges. Here is your performance summary.</p>
            </div>
             <div class="bg-white p-6 rounded-lg shadow-md">
                <div id="final-score-container" class="text-center mb-4">
                    <h3 class="text-xl font-bold mb-1">談判練習總分</h3>
                    <p class="en-text -mt-1 mb-2">Final Negotiation Score</p>
                    <p id="final-score" class="text-5xl font-bold text-sky-600"></p>
                    <p id="final-score-logic" class="text-sm text-slate-500 mt-2"></p>
                </div>
                <div class="overflow-x-auto">
                    <table class="w-full text-sm text-left">
                        <thead id="final-summary-table-head" class="bg-slate-100"></thead>
                        <tbody id="final-summary-table-body"></tbody>
                    </table>
                </div>
            </div>
            <div class="bg-white p-6 rounded-lg shadow-md">
                <div class="text-center">
                     <button id="toggle-discussion-btn" class="bg-gray-200 text-gray-800 font-bold py-2 px-6 rounded-lg hover:bg-gray-300 transition mb-4">
                        顯示討論問題 <span class="text-gray-500 ml-1">Show Discussion Questions</span>
                    </button>
                </div>
                <div id="discussion-container" class="hidden">
                    <h2 class="text-2xl font-bold text-slate-800 mb-1">情境反思與討論</h2>
                    <p class="en-text -mt-1 mb-4">Scenario Reflection & Discussion</p>
                    <div id="discussion-questions" class="space-y-4 text-slate-700"></div>
                </div>
            </div>
            <div class="text-center mt-6">
                <button id="restart-series-btn" class="bg-sky-600 text-white font-bold py-3 px-8 rounded-lg shadow-lg hover:bg-sky-700 transition-transform transform hover:scale-105">返回主選單 <span class="text-sky-200">Back to Main Menu</span></button>
            </div>
        </div>
    </div>

<script>
document.addEventListener('DOMContentLoaded', () => {
    const screens = { instruction: document.getElementById('instruction-screen'), themeSelection: document.getElementById('theme-selection-screen'), scene: document.getElementById('scene-screen'), game: document.getElementById('game-screen'), report: document.getElementById('report-screen'), finalSummary: document.getElementById('final-summary-screen') };
    const buttons = { 
        goToThemeSelection: document.getElementById('go-to-theme-selection-btn'),
        themeBtns: document.querySelectorAll('.theme-btn'),
        startGame: document.getElementById('start-game-btn'), 
        submitOffer: document.getElementById('submit-offer-btn'), 
        endNegotiation: document.getElementById('end-negotiation-btn'), 
        viewBatna: document.getElementById('view-batna-btn'), 
        nextRound: document.getElementById('next-round-btn'), 
        viewSummary: document.getElementById('view-summary-btn'), 
        restartSeries: document.getElementById('restart-series-btn'), 
        modalClose: document.getElementById('modal-close-btn'),
        toggleDiscussion: document.getElementById('toggle-discussion-btn')
    };
    const displays = {
        sceneTitle: document.getElementById('scene-title'), sceneTitleEn: document.getElementById('scene-title-en'), sceneDescription: document.getElementById('scene-description'), sceneDescriptionEn: document.getElementById('scene-description-en'),
        sceneUserParams: document.getElementById('scene-user-params'), sceneUserBatna: document.getElementById('scene-user-batna'),
        negotiationForm: document.getElementById('negotiation-form'),
        obligationTitle: document.getElementById('obligation-title'), obligationTitleEn: document.getElementById('obligation-title-en'),
        obligationDefsStart: document.getElementById('obligation-definitions-start'), aiResponse: document.getElementById('ai-response'), 
        aiOpponentTitle: document.getElementById('ai-opponent-title'), aiOpponentTitleEn: document.getElementById('ai-opponent-title-en'),
        aiStyleInfo: document.getElementById('ai-style-info'), aiStyleInfoEn: document.getElementById('ai-style-info-en'), aiLeakedInfo: document.getElementById('ai-leaked-info'),
        resultTitle: document.getElementById('result-title'), resultText: document.getElementById('result-text'), reportAiStyle: document.getElementById('report-ai-style'), 
        reportTableHead: document.getElementById('report-table-head'), reportTableBody: document.getElementById('report-table-body'),
        dealZoneAnalysis: document.getElementById('deal-zone-analysis'), behaviorStats: document.getElementById('behavior-stats'), satisfactionScores: document.getElementById('satisfaction-scores'), smartTips: document.getElementById('smart-tips'),
        successModal: document.getElementById('success-modal'), successModalTitle: document.getElementById('success-modal-title'), successModalTitleEn: document.getElementById('success-modal-title-en'), successModalText: document.getElementById('success-modal-text'), successModalTextEn: document.getElementById('success-modal-text-en'),
        modal: document.getElementById('modal'), modalTitle: document.getElementById('modal-title'), modalTitleEn: document.getElementById('modal-title-en'), modalBody: document.getElementById('modal-body'),
        finalSummaryTableHead: document.getElementById('final-summary-table-head'), finalSummaryTableBody: document.getElementById('final-summary-table-body'),
        timer: document.getElementById('timer'),
        finalScore: document.getElementById('final-score'), finalScoreLogic: document.getElementById('final-score-logic'),
        discussionContainer: document.getElementById('discussion-container'),
        discussionQuestions: document.getElementById('discussion-questions')
    };
    
    let gameStateToken = null;
    let timerInterval = null;
    let lastSubmitTimestamp = 0;
    const SUBMIT_COOLDOWN = 15000; // 15 seconds
    let currentInputs = {};
    let currentParamConfigs = {};
    let obligationDefs = {};

    async function apiCall(action, payload = {}) {
        try {
            const response = await fetch('/api/negotiate', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ action, ...payload }),
            });
            if (!response.ok) {
                const errorData = await response.json().catch(() => ({ details: 'Server returned a non-JSON error response.' }));
                throw new Error(errorData.details || `Server Error: ${response.status}`);
            }
            const data = await response.json();
            if (data.error) {
                throw new Error(data.details || data.error);
            }
            return data;
        } catch (error) {
            console.error('API call failed:', error);
            alert(`與伺服器通信失敗，請檢查網路連線或刷新頁面重試。\nCommunication with the server failed. Please check your network connection or refresh and try again.\n\n錯誤詳情 (Error Details): ${error.message}`);
            return null;
        }
    }

    function switchScreen(screenName) { Object.values(screens).forEach(s => s.classList.remove('active')); screens[screenName].classList.add('active'); }
    function showModal(title, title_en, bodyHTML) { displays.modal.classList.remove('hidden'); displays.modal.classList.add('flex'); displays.modalTitle.textContent = title; displays.modalTitleEn.textContent = title_en; displays.modalBody.innerHTML = bodyHTML; setTimeout(() => { if (displays.modal.querySelector('.modal-content')) displays.modal.querySelector('.modal-content').classList.remove('scale-95', 'opacity-0'); }, 10); }
    function hideModal() { if (displays.modal.querySelector('.modal-content')) displays.modal.querySelector('.modal-content').classList.add('scale-95', 'opacity-0'); setTimeout(() => {displays.modal.classList.add('hidden'); displays.modal.classList.remove('flex');}, 300); }
    
    function updateSliderValue(key, value) {
        const paramConfig = currentParamConfigs[key];
        if (!paramConfig) return;
        let displayValue = value;
        
        if (paramConfig.format === 'currency') { displayValue = parseInt(value).toLocaleString(); }
        else if (paramConfig.format === 'percent' || (paramConfig.unit && paramConfig.unit.includes('%'))) { displayValue = `${value}%`; }
        else if (paramConfig.format === 'level' && paramConfig.levels) {
            const levelInfo = paramConfig.levels[value];
            displayValue = levelInfo ? `${value} (${levelInfo.name} / ${levelInfo.en_name})` : value;
            const descElement = document.getElementById(`${key}-description-game`);
            if (descElement && obligationDefs[value]) {
                descElement.innerHTML = `等級 ${value}: ${obligationDefs[value]}`;
            }
        } else {
             displayValue = `${parseFloat(value).toLocaleString()} ${(paramConfig.unit || '')}`;
        }
        
        const valueDisplay = document.getElementById(`${key}-value`);
        if (valueDisplay) valueDisplay.textContent = displayValue;
    }

    function toggleButtonLoading(button, isLoading, text = '') {
        if (!button) return;
        if (isLoading) {
            button.disabled = true;
            if (!button.dataset.originalText) button.dataset.originalText = button.innerHTML;
            button.innerHTML = `<div class="loading-spinner"></div>`;
        } else {
            button.disabled = false;
            if (text) {
                button.innerHTML = text;
                button.dataset.originalText = text;
            } else if (button.dataset.originalText) {
                button.innerHTML = button.dataset.originalText;
            }
        }
    }

    function stopTimer() { clearInterval(timerInterval); timerInterval = null; }

    function startTimer() {
        stopTimer(); 
        let timeLeft = 300; // 5 minutes
        displays.timer.textContent = "05:00";
        timerInterval = setInterval(() => {
            timeLeft--;
            const minutes = Math.floor(timeLeft / 60);
            const seconds = timeLeft % 60;
            displays.timer.textContent = `${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;
            if (timeLeft <= 0) {
                stopTimer();
                alert("時間到！談判自動結束。\nTime's up! The negotiation has ended automatically.");
                handleEndNegotiation();
            }
        }, 1000);
    }
    
    function createSliders(params, sliderConfig, initialOffer) {
        let formHTML = '';
        currentParamConfigs = params;
        for (const key in params) {
            const param = params[key];
            const config = sliderConfig[key];
            const initialValue = initialOffer[key];
            formHTML += `<div><label for="${key}" class="flex justify-between font-medium"><span>${param.name} (${param.en_name})</span><span id="${key}-value" class="font-bold text-sky-600"></span></label>
            <input type="range" id="${key}" min="${config.min}" max="${config.max}" step="${config.step}" value="${initialValue}">`;
            if (param.format === 'level') {
                 formHTML += `<div id="${key}-description-game" class="mt-2 text-sm bg-slate-100 p-3 rounded-md text-slate-700"></div>`;
            }
            formHTML += `</div>`;
        }
        displays.negotiationForm.innerHTML = formHTML;
        currentInputs = {};
        for (const key in params) {
            currentInputs[key] = document.getElementById(key);
            currentInputs[key].addEventListener('input', (e) => updateSliderValue(key, e.target.value));
            updateSliderValue(key, initialOffer[key]);
        }
    }

    async function init(payload) {
        switchScreen('scene');
        buttons.themeBtns.forEach(btn => btn.disabled = true);
        toggleButtonLoading(buttons.startGame, true, ' ');
        
        const data = await apiCall('init', payload);
        buttons.themeBtns.forEach(btn => btn.disabled = false);
        
        if (data && (data.scene || data.isGameOver)) {
            if(data.isGameOver) {
                renderFinalSummary(data);
                return;
            }
            gameStateToken = data.token;
            
            displays.sceneTitle.textContent = data.scene.title;
            displays.sceneTitleEn.textContent = data.scene.en_title;
            displays.sceneDescription.innerHTML = data.scene.desc;
            displays.sceneDescriptionEn.innerHTML = data.scene.en_desc;
            displays.sceneUserParams.innerHTML = Object.values(data.scene.userParams).map(p => `<li><strong>${p.name} (${p.en_name})</strong>: 期望 <span class="text-green-600">${p.expect.toLocaleString()}${p.unit || ''}</span> | 底線 <span class="text-red-600">${p.reserve.toLocaleString()}${p.unit || ''}</span></li>`).join('');
            displays.sceneUserBatna.innerHTML = data.scene.userBatnaHTML;
            
            displays.aiStyleInfo.textContent = data.aiStyleName;
            displays.aiStyleInfoEn.textContent = data.aiStyleEnName;
            displays.aiLeakedInfo.innerHTML = data.leakedInfoHTML;

            displays.aiOpponentTitle.textContent = data.scene.aiOpponent.name;
            displays.aiOpponentTitleEn.textContent = data.scene.aiOpponent.en_name;

            displays.obligationTitle.innerHTML = data.scene.obligationTitle;
            displays.obligationTitleEn.innerHTML = data.scene.en_obligationTitle;
            obligationDefs = data.scene.obligationDefs || {};
            displays.obligationDefsStart.innerHTML = Object.entries(obligationDefs).map(([i, desc]) => {
                const levelKey = Object.keys(data.scene.userParams).find(k => data.scene.userParams[k].format === 'level');
                const levelInfo = data.scene.userParams[levelKey]?.levels?.[i] || { name: '', en_name: '' };
                return `<p><span class="font-bold">等級 ${i} (${levelInfo.name} / ${levelInfo.en_name}):</span> ${desc}</p>`
            }).join('');
            
            createSliders(data.scene.userParams, data.sliderConfig, data.initialOffer);
            
            const buttonText = data.isPractice 
                ? '開始練習輪 <span class="text-sky-200 ml-1">Start Practice</span>' 
                : `開始第 ${data.roundNum} / 5 輪 <span class="text-sky-200 ml-1">Start Round ${data.roundNum}/5</span>`;
            toggleButtonLoading(buttons.startGame, false, buttonText);
        } else {
             toggleButtonLoading(buttons.startGame, false, '初始化失敗，請重試');
        }
        displays.aiResponse.innerHTML = '等待您提交第一個方案...<p class="en-text">Waiting for your first offer...</p>';
    }

    async function handleSubmitOffer() {
        const now = Date.now();
        if (now - lastSubmitTimestamp < SUBMIT_COOLDOWN) {
            showModal(
                '提交過於頻繁！', 'Submission Too Frequent!',
                `<p>冷靜一下，思考是談判中最強大的武器！請等待 ${Math.ceil((SUBMIT_COOLDOWN - (now - lastSubmitTimestamp))/1000)} 秒。</p><p class="en-text">Calm down, thinking is the most powerful weapon in negotiation! Please wait ${Math.ceil((SUBMIT_COOLDOWN - (now - lastSubmitTimestamp))/1000)} seconds.</p><p class="mt-2 text-sm text-amber-700">（此行為已被記錄為一次「非理性思考」）<br><span class="en-text">(This action has been recorded as one "irrational move")</span></p>`
            );
            apiCall('irrationalMove', { token: gameStateToken }).then(data => { if (data && data.token) gameStateToken = data.token; });
            return;
        }
        lastSubmitTimestamp = now;
        toggleButtonLoading(buttons.submitOffer, true);
        const offer = Object.fromEntries(Object.entries(currentInputs).map(([key, input]) => [key, parseFloat(input.value)]));
        const data = await apiCall('submit', { token: gameStateToken, offer });
        toggleButtonLoading(buttons.submitOffer, false);
        if (data && data.token) {
            gameStateToken = data.token;
            if (data.isDeal) {
                stopTimer();
                showSuccessAndReport(data.reportData);
            } else {
                displays.aiResponse.innerHTML = data.aiResponseHTML;
            }
        }
    }

    function showSuccessAndReport(reportData) {
        displays.successModalTitle.innerHTML = reportData.successModal.title;
        displays.successModalTitleEn.innerHTML = reportData.successModal.en_title;
        displays.successModalText.innerHTML = reportData.successModal.text;
        displays.successModalTextEn.innerHTML = reportData.successModal.en_text;
        displays.successModal.classList.remove('hidden');
        displays.successModal.classList.add('flex');
        setTimeout(() => { if (displays.successModal.querySelector('div')) displays.successModal.querySelector('div').classList.remove('scale-95', 'opacity-0'); }, 10);
        setTimeout(() => {
            if (displays.successModal.querySelector('div')) displays.successModal.querySelector('div').classList.add('scale-95', 'opacity-0');
            setTimeout(() => {
                displays.successModal.classList.add('hidden');
                displays.successModal.classList.remove('flex');
                renderReport(reportData);
            }, 300);
        }, 2500);
    }
    
    async function handleEndNegotiation() {
        stopTimer();
        const offer = Object.fromEntries(Object.entries(currentInputs).map(([key, input]) => [key, parseFloat(input.value)]));
        const data = await apiCall('end', { token: gameStateToken, offer });
        if (data) {
             gameStateToken = data.token;
             renderReport(data.reportData);
        }
    }

    function renderReport(data) {
        displays.resultTitle.textContent = data.isSuccess ? '談判成功！' : '談判破裂';
        displays.resultText.innerHTML = data.resultText;
        displays.reportAiStyle.innerHTML = data.aiStyleName;
        displays.reportTableHead.innerHTML = data.reportTableHeadHTML;
        displays.reportTableBody.innerHTML = data.reportTableBodyHTML;
        displays.dealZoneAnalysis.innerHTML = data.dealZoneAnalysisHTML;
        displays.behaviorStats.innerHTML = data.behaviorStatsHTML;
        displays.satisfactionScores.innerHTML = data.satisfactionScoresHTML;
        displays.smartTips.innerHTML = data.smartTipsHTML;
        if (data.isPracticeRoundOver) {
            buttons.nextRound.innerHTML = '開始正式挑戰 <span class="text-sky-200">Start Official Challenge</span>';
        } else {
            buttons.nextRound.innerHTML = '下一輪 <span class="text-sky-200">Next Round</span>';
        }
        if (data.isGameOver) {
            buttons.nextRound.classList.add('hidden');
            buttons.viewSummary.classList.remove('hidden');
            buttons.viewSummary.onclick = () => init({ token: gameStateToken });
        } else {
            buttons.nextRound.classList.remove('hidden');
            buttons.viewSummary.classList.add('hidden');
        }
        switchScreen('report');
    }

    function renderFinalSummary(data) {
        const { gameHistory, finalScore, discussionQuestions, finalSummaryTableHeadHTML } = data;
        displays.finalScore.textContent = `${finalScore.score} / 100`;
        displays.finalScoreLogic.innerHTML = finalScore.logic;
        displays.finalSummaryTableHead.innerHTML = finalSummaryTableHeadHTML;
        displays.finalSummaryTableBody.innerHTML = gameHistory.map(round => {
            const resultClass = round.isSuccess ? 'text-green-600' : 'text-red-600';
            const userScore = round.satisfaction.user !== '--' ? `${round.satisfaction.user} / 10` : '--';
            const aiScore = round.satisfaction.ai !== '--' ? `${round.satisfaction.ai} / 10` : '--';
            const dealTerms = round.isSuccess && round.finalOfferHTML ? round.finalOfferHTML : '--';
            const overConcessionCount = round.satisfaction.penaltyReasons ? round.satisfaction.penaltyReasons.length : 0;
            return `<tr class="border-b">
                <td class="p-3 font-medium">${round.styleName}<p class="en-text">${round.en_styleName}</p></td>
                <td class="p-3 font-bold ${resultClass}">${round.isSuccess ? '談成' : '破裂'}<p class="en-text font-normal">${round.isSuccess ? 'Deal' : 'No Deal'}</p></td>
                <td class="p-3 text-sm">${dealTerms}</td>
                <td class="p-3 text-center">${round.offersSubmitted}</td>
                <td class="p-3 text-center">${round.batnaViews}</td>
                <td class="p-3 text-center text-amber-600 font-bold">${overConcessionCount}</td>
                <td class="p-3 text-center text-red-600 font-bold">${round.irrationalMoves}</td>
                <td class="p-3">${userScore}</td>
                <td class="p-3">${aiScore}</td>
            </tr>`;
        }).join('');
        displays.discussionQuestions.innerHTML = discussionQuestions;
        displays.discussionContainer.classList.add('hidden');
        buttons.toggleDiscussion.innerHTML = '顯示討論問題 <span class="text-gray-500 ml-1">Show Discussion Questions</span>';
        switchScreen('finalSummary');
    }

    buttons.goToThemeSelection.addEventListener('click', () => switchScreen('themeSelection'));
    buttons.themeBtns.forEach(btn => {
        btn.addEventListener('click', () => {
            const theme = btn.dataset.theme;
            init({ theme });
        });
    });
    buttons.startGame.addEventListener('click', () => { lastSubmitTimestamp = Date.now(); switchScreen('game'); startTimer(); });
    buttons.submitOffer.addEventListener('click', handleSubmitOffer);
    buttons.endNegotiation.addEventListener('click', handleEndNegotiation);
    buttons.nextRound.addEventListener('click', () => init({ token: gameStateToken }));
    buttons.restartSeries.addEventListener('click', () => { 
        gameStateToken = null; 
        switchScreen('instruction'); 
    });
    buttons.viewBatna.addEventListener('click', async () => {
        const data = await apiCall('viewBatna', { token: gameStateToken });
        if (data && data.token) {
            gameStateToken = data.token;
            showModal('您的 BATNA (最佳替代方案)', 'Your BATNA (Best Alternative to a Negotiated Agreement)', data.batnaHTML);
        }
    });
    buttons.modalClose.addEventListener('click', hideModal);
    buttons.toggleDiscussion.addEventListener('click', () => {
        const isHidden = displays.discussionContainer.classList.toggle('hidden');
        if(isHidden) {
            buttons.toggleDiscussion.innerHTML = '顯示討論問題 <span class="text-gray-500 ml-1">Show Discussion Questions</span>';
        } else {
            buttons.toggleDiscussion.innerHTML = '隱藏討論問題 <span class="text-gray-500 ml-1">Hide Discussion Questions</span>';
        }
    });
});
</script>

</body>
</html>
