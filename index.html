<!DOCTYPE html>
<html lang="zh-Hant">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>談判思維刻意練習場 / Negotiation Sandbox</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@400;500;700&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Noto Sans TC', sans-serif; }
        .screen { display: none; }
        .screen.active { display: block; }
        input[type=range] { -webkit-appearance: none; appearance: none; width: 100%; height: 8px; background: #d3d3d3; outline: none; opacity: 0.7; transition: opacity .2s; border-radius: 5px; }
        input[type=range]:hover { opacity: 1; }
        input[type=range]::-webkit-slider-thumb { -webkit-appearance: none; appearance: none; width: 20px; height: 20px; background: #0ea5e9; cursor: pointer; border-radius: 50%; border: 2px solid white; box-shadow: 0 0 5px rgba(0,0,0,0.2); }
        input[type=range]::-moz-range-thumb { width: 20px; height: 20px; background: #0ea5e9; cursor: pointer; border-radius: 50%; border: 2px solid white; box-shadow: 0 0 5px rgba(0,0,0,0.2); }
        .hidden { display: none; }
        .flex { display: flex; }
        .modal-overlay { transition: opacity 0.3s ease; }
        .modal-content { transition: transform 0.3s ease, opacity 0.3s ease; }
        @keyframes fade-in-up { from { transform: translateY(20px) scale(0.95); opacity: 0; } to { transform: translateY(0) scale(1); opacity: 1; } }
        .animate-fade-in-up { animation: fade-in-up 0.3s ease-out forwards; }
        .loading-spinner { border: 4px solid rgba(255, 255, 255, 0.3); border-left-color: #ffffff; border-radius: 50%; width: 24px; height: 24px; animation: spin 1s linear infinite; }
        @keyframes spin { to { transform: rotate(360deg); } }
        .en-text { color: #64748b; font-size: 0.875rem; margin-top: -0.25rem; }
    </style>
</head>
<body class="bg-slate-100 text-slate-800">

    <div id="app" class="container mx-auto p-4 md:p-8 max-w-5xl">
        <div id="modal" class="fixed inset-0 bg-black bg-opacity-60 items-center justify-center z-50 hidden modal-overlay">
            <div class="bg-white p-6 rounded-lg shadow-xl w-11/12 max-w-md transform scale-95 opacity-0 modal-content">
                <h2 id="modal-title" class="text-2xl font-bold text-slate-800 mb-1"></h2>
                <p id="modal-title-en" class="en-text -mt-1 mb-4"></p>
                <div id="modal-body" class="text-slate-600 space-y-2"></div>
                <div class="text-right mt-6">
                    <button id="modal-close-btn" class="bg-sky-600 text-white font-bold py-2 px-6 rounded-lg hover:bg-sky-700 transition">關閉 <span class="text-sky-200 ml-1">Close</span></button>
                </div>
            </div>
        </div>
        <div id="success-modal" class="fixed inset-0 bg-black bg-opacity-60 items-center justify-center z-50 hidden">
            <div class="bg-white p-8 rounded-lg shadow-xl text-center transform transition-all scale-95 opacity-0 animate-fade-in-up">
                <h2 id="success-title" class="text-3xl font-bold text-green-600">成交！</h2>
                <p id="success-title-en" class="en-text text-green-500">Deal!</p>
                <p id="success-message" class="text-lg mt-2 text-slate-700">這工程有勞你了！</p>
                <p id="success-message-en" class="en-text">We're counting on you for this project!</p>
            </div>
        </div>
        <header class="text-center mb-8">
            <h1 class="text-3xl md:text-4xl font-bold text-slate-900">談判思維刻意練習場</h1>
            <p class="en-text -mt-1">Negotiation Sandbox</p>
            <p class="text-slate-600 mt-2">在模擬場景中，磨練您的談判技巧</p>
            <p class="en-text">Hone your negotiation skills in a simulated environment</p>
        </header>

        <div id="instruction-screen" class="screen active space-y-6">
            <div class="bg-white p-6 rounded-lg shadow-md">
                <h2 class="text-2xl font-bold mb-1">歡迎來到談判練習場</h2>
                <p class="en-text -mt-1 mb-4">Welcome to the Negotiation Sandbox</p>
                
                <div class="space-y-4">
                    <div>
                        <h3 class="text-lg font-bold text-sky-700">遊戲目標 (Game Goal)</h3>
                        <p class="text-slate-600 mt-1">本遊戲旨在幫您練習三大核心談判思維。您的 **BATNA** (最佳替代方案) 決定了您的談判底線；我方的底線與您的底線共同構成了 **ZOPA** (可能成交區間)，所有成功的協議都在此發生；當 ZOPA 過於狹窄時，您需要利用 **Trade-on** (價值交換)，透過放棄次要利益來換取核心利益，從而達成協議。</p>
                        <p class="en-text text-slate-500">This game helps you practice three core negotiation concepts. Your **BATNA** determines your bottom line. The overlap between your bottom line and your opponent's forms the **ZOPA**, where all successful agreements happen. When the ZOPA is narrow, you must use **Trade-ons** (exchanging concessions on minor issues for gains on major ones) to create value and reach a deal.</p>
                    </div>
                    <div>
                        <h3 class="text-lg font-bold text-sky-700">行為準則 (Rules of Conduct)</h3>
                        <ul class="list-disc list-inside space-y-1 mt-1 text-slate-600">
                            <li><b>五輪挑戰 (Five Rounds Challenge):</b> 您將面對五位風格各異的對手，請盡力在每一輪中達成最佳協議。</li>
                            <li><b>時間壓力 (Time Pressure):</b> 每輪談判限時 **5 分鐘**，超時將導致談判破裂。</li>
                            <li><b>深思熟慮 (Think Carefully):</b> 兩次提交方案之間需間隔 **30 秒**。過於倉促的決策將被記錄為「非理性思考」。</li>
                            <li><b>避免過度讓步 (Avoid Over-concession):</b> 做出遠超對手期望的讓步會被記錄，並影響您的滿意度評分。</li>
                        </ul>
                    </div>
                    <div>
                        <h3 class="text-lg font-bold text-sky-700">操作步驟 (How to Play)</h3>
                        <ol class="list-decimal list-inside space-y-1 mt-1 text-slate-600">
                           <li><b>閱讀開局信息 (Read Initial Info):</b> 點擊下方按鈕，仔細閱讀您的目標及對手情报。</li>
                           <li><b>開始談判 (Start Negotiating):</b> 點擊「開始談判」按鈕進入談判室。</li>
                           <li><b>調整與提交 (Adjust & Submit):</b> 使用滑桿調整方案，點擊「提交方案」。</li>
                           <li><b>複盤與總結 (Review & Summarize):</b> 每輪結束後查看報告，五輪後將提供總結。</li>
                        </ol>
                    </div>
                </div>
            </div>
            <div class="text-center">
                <button id="accept-instructions-btn" class="bg-sky-600 text-white font-bold py-3 px-8 rounded-lg shadow-lg hover:bg-sky-700 transition-transform transform hover:scale-105">
                    我明白了，選擇身份 <span class="text-sky-200 ml-1">I Understand, Select Role</span>
                </button>
            </div>
        </div>
        
        <div id="identity-screen" class="screen space-y-6">
             <div class="bg-white p-6 rounded-lg shadow-md text-center">
                 <h2 class="text-2xl font-bold mb-1">請選擇您的身份</h2>
                 <p class="en-text -mt-1 mb-4">Please Select Your Role</p>
                 <div class="grid md:grid-cols-3 gap-4">
                     <button data-identity="student" class="identity-choice-btn bg-white p-6 rounded-lg shadow-md hover:shadow-xl hover:ring-2 hover:ring-sky-500 transition">
                         <h3 class="text-lg font-bold text-sky-700">高校就讀學生</h3>
                         <p class="en-text">University Student</p>
                     </button>
                     <button data-identity="professional" class="identity-choice-btn bg-white p-6 rounded-lg shadow-md hover:shadow-xl hover:ring-2 hover:ring-sky-500 transition">
                         <h3 class="text-lg font-bold text-sky-700">在職工作人士</h3>
                         <p class="en-text">Working Professional</p>
                     </button>
                     <button data-identity="general" class="identity-choice-btn bg-white p-6 rounded-lg shadow-md hover:shadow-xl hover:ring-2 hover:ring-sky-500 transition">
                         <h3 class="text-lg font-bold text-sky-700">跨領域/通識學員</h3>
                         <p class="en-text">General Audience</p>
                     </button>
                 </div>
             </div>
        </div>

        <div id="scene-screen" class="screen space-y-6">
            <div class="bg-white p-6 rounded-lg shadow-md">
                <h2 id="scene-title" class="text-2xl font-bold mb-1"></h2>
                <p id="scene-title-en" class="en-text -mt-1 mb-4 border-b pb-2"></p>
                <p id="scene-description"></p>
                <p id="scene-description-en" class="en-text"></p>
            </div>
            <div class="grid md:grid-cols-2 gap-6">
                <div class="bg-white p-6 rounded-lg shadow-md">
                    <h3 class="text-xl font-bold mb-1">您的核心利益參數</h3>
                    <p class="en-text -mt-1 mb-4">Your Core Interests</p>
                    <ul id="scene-user-params" class="space-y-3"></ul>
                </div>
                <div class="bg-white p-6 rounded-lg shadow-md">
                    <h3 class="text-xl font-bold mb-1">您的 BATNA (最佳替代方案)</h3>
                    <p class="en-text -mt-1 mb-4">Your BATNA</p>
                    <div id="scene-user-batna" class="bg-amber-100 border-l-4 border-amber-500 text-amber-800 p-4 rounded-r-lg"></div>
                </div>
            </div>
            <div id="definitions-box" class="bg-white p-6 rounded-lg shadow-md">
                <h3 class="text-xl font-bold mb-1">談判變數定義</h3>
                <p class="en-text -mt-1 mb-4">Parameter Definitions</p>
                <div id="definitions-content" class="text-sm space-y-2 text-slate-600"></div>
            </div>
            <div class="bg-white p-6 rounded-lg shadow-md">
                <h2 class="text-2xl font-bold mb-1 text-center">開局信息</h2>
                <p class="en-text text-center -mt-1 mb-4">Initial Information</p>
                <div id="info-box" class="bg-sky-100 border-t-4 border-sky-500 rounded-b text-sky-900 px-4 py-3 shadow-md" role="alert"><div class="flex"><div class="py-1"><svg class="fill-current h-6 w-6 text-sky-500 mr-4" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20"><path d="M2.93 17.07A10 10 0 1 1 17.07 2.93 10 10 0 0 1 2.93 17.07zM9 11v4h2v-4H9zm0-4h2v2H9V7z"/></svg></div><div>
                    <p class="font-bold">本次 AI 對手的談判風格為：<span id="ai-style-info" class="text-red-600"></span></p>
                    <p class="en-text">This round's AI opponent negotiation style: <span id="ai-style-info-en" class="text-red-600"></span></p>
                    <p class="text-sm mt-2" id="ai-leaked-info"></p>
                </div></div></div>
            </div>
            <div class="text-center">
                <button id="start-game-btn" class="bg-sky-600 text-white font-bold py-3 px-8 rounded-lg shadow-lg hover:bg-sky-700 transition-transform transform hover:scale-105 disabled:bg-slate-400 flex items-center justify-center">
                    <!-- Text set by JS -->
                </button>
            </div>
        </div>
        
        <div id="game-screen" class="screen"><div class="grid lg:grid-cols-3 gap-6"><div class="lg:col-span-2 bg-white p-6 rounded-lg shadow-md">
            <div class="flex justify-between items-center mb-6 border-b pb-3">
                <div>
                    <h2 class="text-2xl font-bold mb-1">您的方案</h2>
                    <p class="en-text -mt-1">Your Offer</p>
                </div>
                <div class="text-center">
                    <p class="text-sm text-slate-500">剩餘時間 (Time Left)</p>
                    <div id="timer" class="text-2xl font-bold text-red-600">05:00</div>
                </div>
            </div>
            <div id="negotiation-form" class="space-y-6"><div><label for="param1" class="flex justify-between font-medium"><span></span><span id="param1-value" class="font-bold text-sky-600"></span></label><input type="range" id="param1"></div><div><label for="param2" class="flex justify-between font-medium"><span></span><span id="param2-value" class="font-bold text-sky-600"></span></label><input type="range" id="param2"></div><div><label for="param3" class="flex justify-between font-medium"><span></span><span id="param3-value" class="font-bold text-sky-600"></span></label><input type="range" id="param3"></div><div><label for="param4" class="flex justify-between font-medium"><span></span><span id="param4-value" class="font-bold text-sky-600"></span></label><input type="range" id="param4"></div><div><label for="param5" class="flex justify-between font-medium"><span></span><span id="param5-value" class="font-bold text-sky-600"></span></label><input type="range" id="param5"><div id="param5-description-game" class="mt-2 text-sm bg-slate-100 p-3 rounded-md text-slate-700"></div></div></div><div class="mt-8 flex flex-wrap gap-4 items-center"><button id="submit-offer-btn" class="bg-sky-600 text-white font-bold py-2 px-6 rounded-lg hover:bg-sky-700 transition disabled:bg-slate-400 flex items-center justify-center gap-2">提交方案 <span class="text-sky-200">Submit</span></button><button id="end-negotiation-btn" class="bg-red-500 text-white font-bold py-2 px-6 rounded-lg hover:bg-red-600 transition">放棄談判 <span class="text-red-200">End</span></button></div></div><div class="space-y-6"><div class="bg-white p-4 rounded-lg shadow-md">
            <h3 class="text-lg font-bold mb-1">對手回應</h3>
            <p class="en-text -mt-1 mb-3">Opponent's Response</p>
            <div id="ai-response" class="min-h-[100px] bg-slate-100 p-3 rounded-md text-slate-700 italic">
                等待您提交第一個方案...
                <p class="en-text">Waiting for your first offer...</p>
            </div>
        </div><div class="bg-white p-4 rounded-lg shadow-md">
            <h3 class="text-lg font-bold mb-1">您的底線</h3>
            <p class="en-text -mt-1 mb-3">Your Bottom Line</p>
            <button id="view-batna-btn" class="w-full bg-amber-500 text-white font-bold py-2 px-4 rounded-lg hover:bg-amber-600 transition">查看我的 BATNA <span class="text-amber-200">View My BATNA</span></button>
        </div></div></div></div>

        <div id="report-screen" class="screen space-y-6"><div id="result-summary" class="p-6 rounded-lg shadow-md text-center"><h2 id="result-title" class="text-4xl font-bold mb-2"></h2><p id="result-text" class="text-lg"></p><p class="text-md text-slate-600 mt-2">本次對手的談判風格為 (Opponent's negotiation style): <span id="report-ai-style" class="font-bold"></span></p></div><div class="bg-white p-6 rounded-lg shadow-md">
            <h3 class="text-xl font-bold mb-1">最終方案對比</h3>
            <p class="en-text -mt-1 mb-4">Final Offer Comparison</p>
            <div class="overflow-x-auto"><table class="w-full text-sm text-left"><thead class="bg-slate-100"><tr>
                <th class="p-3">參數<p class="en-text font-normal">Parameter</p></th>
                <th class="p-3 text-sky-600">您的最終方案<p class="en-text font-normal">Your Final Offer</p></th>
                <th class="p-3 text-green-600">您的期望<p class="en-text font-normal">Your Expectation</p></th>
                <th class="p-3 text-red-600">您的底線<p class="en-text font-normal">Your Reserve</p></th>
                <th class="p-3 text-red-600">對手底線<p class="en-text font-normal">Opponent's Reserve</p></th>
                <th class="p-3 text-green-600">對手期望<p class="en-text font-normal">Opponent's Expectation</p></th>
            </tr></thead><tbody id="report-table-body"></tbody></table></div></div><div class="grid md:grid-cols-3 gap-6"><div class="md:col-span-2 bg-white p-6 rounded-lg shadow-md">
            <h3 class="text-xl font-bold mb-1">"成交區間"可視化分析 (ZOPA)</h3>
            <p class="en-text -mt-1 mb-4">Zone of Possible Agreement (ZOPA) Analysis</p>
            <div id="deal-zone-analysis" class="space-y-2"></div></div><div class="space-y-6"><div class="bg-white p-6 rounded-lg shadow-md">
            <h3 class="text-xl font-bold mb-1">行為統計</h3>
            <p class="en-text -mt-1 mb-4">Behavior Statistics</p>
            <ul id="behavior-stats" class="space-y-2"></ul></div><div class="bg-white p-6 rounded-lg shadow-md">
            <h3 class="text-xl font-bold mb-1">雙方滿意度評估</h3>
            <p class="en-text -mt-1 mb-4">Satisfaction Score</p>
            <div id="satisfaction-scores" class="space-y-2"></div></div></div></div><div class="bg-white p-6 rounded-lg shadow-md">
            <h3 class="text-xl font-bold mb-1">智能提示</h3>
            <p class="en-text -mt-1 mb-4">Smart Tips</p>
            <div id="smart-tips" class="bg-sky-100 border-l-4 border-sky-500 text-sky-800 p-4 rounded-r-lg space-y-2"></div></div><div class="text-center mt-6"><button id="next-round-btn" class="bg-sky-600 text-white font-bold py-3 px-8 rounded-lg shadow-lg hover:bg-sky-700 transition-transform transform hover:scale-105">下一輪 <span class="text-sky-200">Next Round</span></button><button id="view-summary-btn" class="bg-purple-600 text-white font-bold py-3 px-8 rounded-lg shadow-lg hover:bg-purple-700 transition-transform transform hover:scale-105 hidden">查看最終總結 <span class="text-purple-200">View Final Summary</span></button></div></div>

        <div id="final-summary-screen" class="screen space-y-6">
            <div class="bg-white p-6 rounded-lg shadow-md text-center">
                <h2 class="text-3xl font-bold text-slate-800">系列談判總結</h2>
                <p class="en-text">Series Negotiation Summary</p>
                <p class="text-slate-600 mt-2">您已完成所有談判風格的挑戰，以下是您的成績總覽。</p>
                <p class="en-text">You have completed all negotiation style challenges. Here is your performance summary.</p>
            </div>
             <div class="bg-white p-6 rounded-lg shadow-md">
                <div id="final-score-container" class="text-center mb-4">
                    <h3 class="text-xl font-bold mb-1">談判練習總分</h3>
                    <p class="en-text -mt-1 mb-2">Final Negotiation Score</p>
                    <p id="final-score" class="text-5xl font-bold text-sky-600"></p>
                    <p id="final-score-logic" class="text-sm text-slate-500 mt-2"></p>
                </div>
                <div class="overflow-x-auto">
                    <table class="w-full text-sm text-left">
                        <thead class="bg-slate-100">
                            <tr>
                                <th class="p-3">談判風格<p class="en-text font-normal">Style</p></th>
                                <th class="p-3">結果<p class="en-text font-normal">Result</p></th>
                                <th class="p-3">成交方案<p class="en-text font-normal">Deal Terms</p></th>
                                <th class="p-3">對話輪次<p class="en-text font-normal">Rounds</p></th>
                                <th class="p-3">BATNA 查看<p class="en-text font-normal">BATNA Views</p></th>
                                <th class="p-3">過度讓步<p class="en-text font-normal">Over-concessions</p></th>
                                <th class="p-3">非理性思考<p class="en-text font-normal">Irrational Moves</p></th>
                                <th class="p-3">您的滿意度<p class="en-text font-normal">Your Score</p></th>
                                <th class="p-3">對手滿意度<p class="en-text font-normal">Opponent's Score</p></th>
                            </tr>
                        </thead>
                        <tbody id="final-summary-table-body"></tbody>
                    </table>
                </div>
            </div>
            <div class="text-center mt-6">
                 <button id="go-to-discussion-btn" class="bg-purple-600 text-white font-bold py-3 px-8 rounded-lg shadow-lg hover:bg-purple-700 transition-transform transform hover:scale-105">
                    前往課後討論 <span class="text-purple-200">Go to Discussion</span>
                </button>
            </div>
        </div>
        
        <div id="discussion-screen" class="screen space-y-6">
            <div class="bg-white p-6 rounded-lg shadow-md">
                <h2 class="text-2xl font-bold mb-1">課後討論與反思</h2>
                <p class="en-text -mt-1 mb-4">Post-Game Discussion & Reflection</p>
                <p class="text-slate-600">請根據您剛剛的遊戲體驗，思考並與您的同伴討論以下為您選擇的問題：</p>
                <p class="en-text">Based on your game experience, please reflect on and discuss the following questions selected for you with your peers:</p>
                <div id="discussion-questions" class="mt-4 space-y-4"></div>
            </div>
            <div class="text-center mt-6">
                <button id="restart-series-btn-final" class="bg-sky-600 text-white font-bold py-3 px-8 rounded-lg shadow-lg hover:bg-sky-700 transition-transform transform hover:scale-105">重新開始新系列 <span class="text-sky-200">Restart Series</span></button>
            </div>
        </div>
    </div>

<script>
document.addEventListener('DOMContentLoaded', () => {
    const screens = { instruction: document.getElementById('instruction-screen'), identity: document.getElementById('identity-screen'), scene: document.getElementById('scene-screen'), game: document.getElementById('game-screen'), report: document.getElementById('report-screen'), finalSummary: document.getElementById('final-summary-screen'), discussion: document.getElementById('discussion-screen') };
    const buttons = { acceptInstructions: document.getElementById('accept-instructions-btn'), startGame: document.getElementById('start-game-btn'), submitOffer: document.getElementById('submit-offer-btn'), endNegotiation: document.getElementById('end-negotiation-btn'), viewBatna: document.getElementById('view-batna-btn'), nextRound: document.getElementById('next-round-btn'), viewSummary: document.getElementById('view-summary-btn'), goToDiscussion: document.getElementById('go-to-discussion-btn'), restartSeries: document.getElementById('restart-series-btn'), restartSeriesFinal: document.getElementById('restart-series-btn-final'), modalClose: document.getElementById('modal-close-btn') };
    const identityChoiceBtns = document.querySelectorAll('.identity-choice-btn');
    const inputs = { param1: document.getElementById('param1'), param2: document.getElementById('param2'), param3: document.getElementById('param3'), param4: document.getElementById('param4'), param5: document.getElementById('param5') };
    const displays = {
        sceneTitle: document.getElementById('scene-title'), sceneTitleEn: document.getElementById('scene-title-en'), sceneDescription: document.getElementById('scene-description'), sceneDescriptionEn: document.getElementById('scene-description-en'),
        sceneUserParams: document.getElementById('scene-user-params'), sceneUserBatna: document.getElementById('scene-user-batna'),
        param1Value: document.getElementById('param1-value'), param2Value: document.getElementById('param2-value'), param3Value: document.getElementById('param3-value'), param4Value: document.getElementById('param4-value'), param5Value: document.getElementById('param5-value'),
        param5DescGame: document.getElementById('param5-description-game'), obligationDefsStart: document.getElementById('definitions-content'), aiResponse: document.getElementById('ai-response'), 
        aiStyleInfo: document.getElementById('ai-style-info'), aiStyleInfoEn: document.getElementById('ai-style-info-en'), aiLeakedInfo: document.getElementById('ai-leaked-info'),
        resultTitle: document.getElementById('result-title'), resultText: document.getElementById('result-text'), reportAiStyle: document.getElementById('report-ai-style'), reportTableBody: document.getElementById('report-table-body'),
        dealZoneAnalysis: document.getElementById('deal-zone-analysis'), behaviorStats: document.getElementById('behavior-stats'), satisfactionScores: document.getElementById('satisfaction-scores'), smartTips: document.getElementById('smart-tips'),
        successModal: document.getElementById('success-modal'), successTitle: document.getElementById('success-title'), successTitleEn: document.getElementById('success-title-en'), successMessage: document.getElementById('success-message'), successMessageEn: document.getElementById('success-message-en'),
        modal: document.getElementById('modal'), modalTitle: document.getElementById('modal-title'), modalTitleEn: document.getElementById('modal-title-en'), modalBody: document.getElementById('modal-body'),
        infoBox: document.getElementById('info-box'),
        finalSummaryTableBody: document.getElementById('final-summary-table-body'),
        timer: document.getElementById('timer'),
        finalScore: document.getElementById('final-score'),
        finalScoreLogic: document.getElementById('final-score-logic'),
        discussionQuestions: document.getElementById('discussion-questions'),
    };
    
    let gameStateToken = null;
    let timerInterval = null;
    let lastSubmitTimestamp = 0;
    let coolDownMessage = { zh: '', en: '' };
    let currentBatna = '';
    let paramKeys = [];

    async function apiCall(action, payload = {}) {
        try {
            const response = await fetch('/api/negotiate', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ action, ...payload }),
            });
            const contentType = response.headers.get("content-type");
            if (!contentType || !contentType.includes("application/json")) {
                 throw new Error("伺服器返回了無效的回應格式(不是JSON)。這很可能是因為預覽環境無法執行後端程式碼，請在部署後測試。\n\nServer returned an invalid format (not JSON). This is likely because the preview environment cannot execute backend code. Please test after deployment.");
            }
            const data = await response.json();
            if (!response.ok) throw new Error(data.details || `伺服器錯誤 (Server Error): ${response.status}`);
            return data;
        } catch (error) {
            console.error('API call failed:', error);
            alert(`與伺服器通信失敗，請刷新頁面重試。\nCommunication with the server failed, please refresh and try again.\n\n錯誤詳情 (Error Details): ${error.message}`);
            return null;
        }
    }

    function switchScreen(screenName) { Object.values(screens).forEach(s => s.classList.remove('active')); screens[screenName].classList.add('active'); }
    function showModal(title, title_en, bodyHTML) { /* ... implementation ... */ }
    function hideModal() { /* ... implementation ... */ }
    function toggleButtonLoading(button, isLoading, text = '') { /* ... implementation ... */ }

    function stopTimer() { clearInterval(timerInterval); timerInterval = null; }
    function startTimer() {
        stopTimer(); 
        let timeLeft = 300; // 5 minutes
        displays.timer.textContent = "05:00";
        timerInterval = setInterval(() => {
            timeLeft--;
            const minutes = Math.floor(timeLeft / 60);
            const seconds = timeLeft % 60;
            displays.timer.textContent = `${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;
            if (timeLeft <= 0) {
                stopTimer();
                alert("時間到！談判自動結束。\nTime's up! The negotiation has ended automatically.");
                handleEndNegotiation();
            }
        }, 1000);
    }
    
    function updateSliderValue(key, value) {
        const pKey = `param${paramKeys.indexOf(key) + 1}`;
        const valueDisplay = displays[`${pKey}Value`];
        const label = document.querySelector(`label[for="${pKey}"] span`);
        if(!label || !valueDisplay) return;
        
        let displayValue = value;
        if (label.dataset.unit === '元' || label.dataset.unit === '%') {
             displayValue = parseInt(value).toLocaleString();
        }
        valueDisplay.textContent = `${displayValue} ${label.dataset.unit || ''}`;
    }

    async function init(payload = {}) {
        switchScreen('scene');
        toggleButtonLoading(buttons.startGame, true);
        
        const data = await apiCall('init', payload);
        
        if (data) {
            if(data.isGameOver) {
                renderFinalSummary(data.gameHistory, data.finalScore, data.discussionQuestions);
                return;
            }
            gameStateToken = data.token;
            coolDownMessage = data.coolDownMessage;
            currentBatna = data.scene.batna.text;
            paramKeys = Object.keys(data.scene.params.user);

            displays.sceneTitle.textContent = data.scene.title;
            displays.sceneTitleEn.textContent = data.scene.en_title;
            displays.sceneDescription.innerHTML = data.scene.desc;
            displays.sceneDescriptionEn.innerHTML = `<p class="en-text">${data.scene.en_desc}</p>`;
            displays.sceneUserParams.innerHTML = Object.values(data.scene.params.user).map(p => `<li><strong>${p.name} (${p.en_name})</strong>: 期望 <span class="text-green-600">${p.expect.toLocaleString()}${p.unit || ''}</span> | 底線 <span class="text-red-600">${p.reserve.toLocaleString()}${p.unit || ''}</span></li>`).join('');
            displays.sceneUserBatna.innerHTML = data.scene.batna.text;

            displays.aiStyleInfo.textContent = data.aiStyleName;
            displays.aiStyleInfoEn.textContent = data.aiStyleEnName;
            displays.aiLeakedInfo.innerHTML = data.leakedInfoHTML;
            
            paramKeys.forEach((key, i) => {
                const pKey = `param${i+1}`;
                const param = data.sliderConfig[key];
                const sceneParam = data.scene.params.user[key];
                const label = document.querySelector(`label[for="${pKey}"] span`);
                if (label) {
                    label.innerHTML = `${sceneParam.name} (${sceneParam.en_name})`;
                    label.dataset.name = sceneParam.name;
                    label.dataset.enName = sceneParam.en_name;
                    label.dataset.unit = sceneParam.unit || '';
                }
                if (inputs[pKey]) {
                    inputs[pKey].min = param.min;
                    inputs[pKey].max = param.max;
                    inputs[pKey].step = param.step;
                    inputs[pKey].value = data.initialOffer[key];
                    updateSliderValue(key, data.initialOffer[key]);
                }
            });
            const buttonText = data.isPractice 
                ? '開始練習輪 <span class="text-sky-200 ml-1">Start Practice</span>' 
                : `開始第 ${data.roundNum} / 5 輪 <span class="text-sky-200 ml-1">Start Round ${data.roundNum}/5</span>`;
            toggleButtonLoading(buttons.startGame, false, buttonText);
        }
    }

    async function handleSubmitOffer() {
        const now = Date.now();
        if (now - lastSubmitTimestamp < 30000) {
            showModal(
                '提交過於頻繁！', 'Submission Too Frequent!',
                `<p>${coolDownMessage.zh}</p><p class="en-text">${coolDownMessage.en}</p><p class="mt-2 text-sm text-amber-700">（此行為已被記錄為一次「非理性思考」）<br><span class="en-text">(This action has been recorded as one "irrational move")</span></p>`
            );
            const data = await apiCall('irrationalMove', { token: gameStateToken });
            if (data) gameStateToken = data.token;
            return;
        }

        lastSubmitTimestamp = now;
        toggleButtonLoading(buttons.submitOffer, true);
        const offer = {};
        paramKeys.forEach((key, i) => {
            offer[key] = parseFloat(inputs[`param${i+1}`].value);
        });
        
        const data = await apiCall('submit', { token: gameStateToken, offer });
        if (data) {
            gameStateToken = data.token;
            if (data.isDeal) {
                stopTimer();
                showSuccessAndReport(data.reportData);
            } else {
                displays.aiResponse.innerHTML = data.aiResponseHTML;
            }
        }
        toggleButtonLoading(buttons.submitOffer, false);
    }

    function showSuccessAndReport(reportData) {
        displays.successTitle.textContent = reportData.successMessage.zh;
        displays.successTitleEn.textContent = reportData.successMessage.en_zh;
        displays.successMessage.textContent = reportData.successMessage.sub_zh;
        displays.successMessageEn.textContent = reportData.successMessage.sub_en;

        displays.successModal.classList.remove('hidden');
        displays.successModal.classList.add('flex');
        setTimeout(() => { if (displays.successModal.querySelector('div')) displays.successModal.querySelector('div').classList.remove('scale-95', 'opacity-0'); }, 10);
        setTimeout(() => {
            if (displays.successModal.querySelector('div')) displays.successModal.querySelector('div').classList.add('scale-95', 'opacity-0');
            setTimeout(() => {
                displays.successModal.classList.add('hidden');
                displays.successModal.classList.remove('flex');
                renderReport(reportData);
            }, 300);
        }, 2500);
    }
    
    async function handleEndNegotiation() {
        stopTimer();
        const offer = {};
        paramKeys.forEach((key, i) => {
            offer[key] = parseFloat(inputs[`param${i+1}`].value);
        });
        const data = await apiCall('end', { token: gameStateToken, offer });
        if (data) {
             gameStateToken = data.token;
             renderReport(data.reportData);
        }
    }

    function renderReport(data) {
        displays.resultTitle.textContent = data.isSuccess ? '談判成功！' : '談判破裂';
        displays.resultText.innerHTML = data.resultText;
        displays.reportAiStyle.innerHTML = data.aiStyleName;
        displays.reportTableBody.innerHTML = data.reportTableHTML;
        displays.dealZoneAnalysis.innerHTML = data.dealZoneAnalysisHTML;
        displays.behaviorStats.innerHTML = data.behaviorStatsHTML;
        displays.satisfactionScores.innerHTML = data.satisfactionScoresHTML;
        displays.smartTips.innerHTML = data.smartTipsHTML;
        
        if (data.isPracticeRoundOver) {
            buttons.nextRound.innerHTML = '開始正式挑戰 <span class="text-sky-200">Start Official Challenge</span>';
        } else {
            buttons.nextRound.innerHTML = `前往第 ${data.roundNum + 1} 輪 <span class="text-sky-200">Go to Round ${data.roundNum + 1}</span>`;
        }

        if (data.isGameOver) {
            buttons.nextRound.classList.add('hidden');
            buttons.viewSummary.classList.remove('hidden');
            buttons.viewSummary.onclick = () => renderFinalSummary(data.gameHistory, data.finalScore, data.discussionQuestions);
        } else {
            buttons.nextRound.classList.remove('hidden');
            buttons.viewSummary.classList.add('hidden');
        }
        
        switchScreen('report');
    }

    function renderFinalSummary(gameHistory, finalScore, discussionQuestions) {
        displays.finalScore.textContent = `${finalScore.score} / 100`;
        displays.finalScoreLogic.innerHTML = finalScore.logic;
        displays.finalSummaryTableBody.innerHTML = gameHistory.map(round => {
            const resultClass = round.isSuccess ? 'text-green-600' : 'text-red-600';
            const userScore = round.satisfaction.user !== '--' ? `${round.satisfaction.user} / 10` : '--';
            const aiScore = round.satisfaction.ai !== '--' ? `${round.satisfaction.ai} / 10` : '--';
            
            const dealTerms = round.isSuccess && round.finalOffer 
                ? `${round.finalOffer.param1.toLocaleString()} / ${round.finalOffer.param2.toLocaleString()}`
                : '--';

            const overConcessionCount = round.satisfaction.penaltyReasons ? round.satisfaction.penaltyReasons.length : 0;

            return `<tr class="border-b">
                <td class="p-3 font-medium">${round.styleName}<p class="en-text">${round.en_styleName}</p></td>
                <td class="p-3 font-bold ${resultClass}">${round.isSuccess ? '談成' : '破裂'}<p class="en-text font-normal">${round.isSuccess ? 'Deal' : 'No Deal'}</p></td>
                <td class="p-3 text-sm">${dealTerms}</td>
                <td class="p-3 text-center">${round.offersSubmitted}</td>
                <td class="p-3 text-center">${round.batnaViews}</td>
                <td class="p-3 text-center text-amber-600 font-bold">${overConcessionCount}</td>
                <td class="p-3 text-center text-red-600 font-bold">${round.irrationalMoves}</td>
                <td class="p-3">${userScore}</td>
                <td class="p-3">${aiScore}</td>
            </tr>`;
        }).join('');
        buttons.goToDiscussion.onclick = () => renderDiscussion(discussionQuestions);
        switchScreen('finalSummary');
    }

    function renderDiscussion(questions) {
        displays.discussionQuestions.innerHTML = questions.map((q, i) => `
            <div class="p-4 bg-slate-50 rounded-lg">
                <p class="font-semibold text-slate-800">${i + 1}. ${q.zh}</p>
                <p class="en-text text-slate-600">${q.en}</p>
            </div>
        `).join('');
        switchScreen('discussion');
    }

    buttons.acceptInstructions.addEventListener('click', () => switchScreen('identity'));
    identityChoiceBtns.forEach(btn => {
        btn.addEventListener('click', () => {
            const identity = btn.dataset.identity;
            init({ identity });
        });
    });
    buttons.startGame.addEventListener('click', () => { 
        lastSubmitTimestamp = Date.now();
        switchScreen('game'); 
        startTimer();
    });
    buttons.submitOffer.addEventListener('click', handleSubmitOffer);
    buttons.endNegotiation.addEventListener('click', handleEndNegotiation);
    buttons.nextRound.addEventListener('click', () => init({ token: gameStateToken }));
    buttons.restartSeries.addEventListener('click', () => switchScreen('instruction'));
    buttons.restartSeriesFinal.addEventListener('click', () => switchScreen('instruction'));
    buttons.viewBatna.addEventListener('click', () => {
        apiCall('viewBatna', { token: gameStateToken }).then(data => { if (data) gameStateToken = data.token; });
        showModal('您的 BATNA (最佳替代方案)', 'Your BATNA (Best Alternative to a Negotiated Agreement)', currentBatna);
    });
    buttons.modalClose.addEventListener('click', hideModal);
    Object.values(inputs).forEach((input, i) => { 
        if (input) { 
            input.addEventListener('input', (e) => {
                 if (paramKeys[i]) updateSliderValue(paramKeys[i], e.target.value);
            }); 
        } 
    });
});
</script>

</body>
</html>

